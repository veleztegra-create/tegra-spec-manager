// asistente-tecnico.js - Código REAL para conectar IA a tu programa

const AsistenteTegra = {
    // Tu API key (guárdala en un lugar seguro)
    API_KEY: 'sk-TU_API_KEY_AQUI', // <-- PON TU LLAVE AQUÍ
    
    // Modelo a usar
    MODELO: 'gpt-4-turbo-preview', // o 'gpt-3.5-turbo' para más barato
    
    // ENDPOINT REAL de OpenAI
    URL: 'https://api.openai.com/v1/chat/completions',
    
    // El conocimiento de tu taller (esto es lo que hace la magia)
    conocimientoBase: `
    CONOCIMIENTO TÉCNICO DEL TALLER TEGRA:
    
    WATERBASE - REGLAS GENERALES:
    - Tela blanca/natural: 2 bases blancas (110, 122) + 1 blocker 157
    - Tela negra/oscura: 3 blockers (110, 122, 157) + bases según colores
    - Temperatura siempre: 320°F
    - Tiempo siempre: 1:40 min
    
    CLASIFICACIÓN DE COLORES:
    - Claros: amarillos, naranjas, rosas, dorados, beiges
    - Oscuros: rojos, azules, verdes, morados, marrones, negros
    - Especiales (3 pantallas): 77C Gold, 78H Amarillo, 761 University Gold
    
    SECUENCIA BLANCO CON COLORES CLAROS:
    1. AquaFlex V2 M110
    2. AquaFlex V2 M122
    3. Blocker CHT M157
    4. AquaFlex V2 M122 + 3% CL 500
    Por cada color claro:
       - Color M157 + 3% CL 500 + 5% ecofix XL
       - Color M198 + 3% CL 500 + 5% ecofix XL
    
    SECUENCIA BLANCO CON COLORES OSCUROS:
    1. AquaFlex V2 M110
    2. AquaFlex V2 M122
    3. Blocker CHT M157
    4. AquaFlex V2 M122 + 3% CL 500
    Por cada color oscuro:
       - Color M157 + 3% CL 500 + 5% ecofix XL
       - Color M198 + 3% CL 500 + 5% ecofix XL
    
    SECUENCIA NEGRO CON COLORES OSCUROS:
    1. Blocker CHT M110
    2. Blocker CHT M122
    3. Blocker CHT M157
    Por cada color claro/medio:
       - AquaFlex V2 M122 + 3% CL 500
       - Color M198 + 3% CL 500 + 5% ecofix XL
       - Color M157 + 3% CL 500 + 5% ecofix XL
    Por cada color oscuro:
       - Color M198 + 3% CL 500 + 5% ecofix XL
       - Color M157 + 3% CL 500 + 5% ecofix XL
    
    REGLA FLASH/COOL:
    - Después de cada pantalla de tinta (excepto la última) va FLASH + COOL
    
    COLORES ESPECIALES (3 PANTALLAS):
    - 77C Gold: M157, M198, M110
    - 78H Amarillo: M157, M198, M110  
    - 761 University Gold: M157, M198, M110
    `,
    
    // Función para generar secuencia
    async generarSecuencia(orden) {
        try {
            const prompt = `
            Basado en este conocimiento técnico:
            ${this.conocimientoBase}
            
            Genera la secuencia de impresión COMPLETA para:
            - Tela: ${orden.tela || 'jersey'}
            - Color de tela: ${orden.colorTela}
            - Tipo de tinta: ${orden.tinta}
            - Colores del diseño: ${orden.colores.join(', ')}
            
            La respuesta debe ser en formato JSON con:
            {
                "secuencia": [
                    {
                        "estacion": 1,
                        "tipo": "WHITE_BASE|BLOCKER|COLOR|FLASH|COOL",
                        "nombre": "AquaFlex V2",
                        "malla": "110",
                        "aditivos": "3% CL 500",
                        "screenLetter": "A"
                    }
                ],
                "totalEstaciones": número,
                "explicacion": "texto explicativo"
            }
            
            IMPORTANTE: Incluye FLASH y COOL entre cada color.
            `;
            
            const respuesta = await fetch(this.URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.API_KEY}`
                },
                body: JSON.stringify({
                    model: this.MODELO,
                    messages: [
                        { role: 'system', content: 'Eres un experto en serigrafía. Genera secuencias precisas basadas en las reglas del taller.' },
                        { role: 'user', content: prompt }
                    ],
                    temperature: 0.3, // Bajo para que sea preciso, no creativo
                    response_format: { type: "json_object" }
                })
            });
            
            const data = await respuesta.json();
            return JSON.parse(data.choices[0].message.content);
            
        } catch (error) {
            console.error('Error con asistente:', error);
            return null;
        }
    },
    
    // Función para guardar NUEVAS reglas
    async guardarRegla(textoRegla) {
        const prompt = `
        Convierte esta regla técnica en formato JSON estructurado:
        
        ${textoRegla}
        
        Responde con JSON que tenga:
        {
            "id": "regla_nombre_unico",
            "condiciones": { ... },
            "secuencia": [ ... ],
            "excepciones": [ ... ]
        }
        `;
        
        // Misma lógica de fetch...
    }
};

// Exportar para usar en tu programa
window.AsistenteTegra = AsistenteTegra;
