<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tegra - Technical Spec Manager (Versión Corregida)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div class="app-container">
        <header class="main-header">
            <div class="logo-container">
                <img src="https://raw.githubusercontent.com/veleztegra-create/tegra-spec-manager/main/assets/tegra-logo.png" alt="Tegra Logo" class="main-logo">
                <h1>Technical Spec Manager</h1>
            </div>
            <div class="header-actions">
                <button class="btn-export" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i> Descargar PDF
                </button>
            </div>
        </header>

        <section class="general-info card">
            <div class="grid-3-cols">
                <div class="input-group">
                    <label>CLIENTE</label>
                    <select id="client-select" onchange="updateClient(this.value)">
                        <option value="FANATICS">FANATICS</option>
                        <option value="GEAR FOR SPORT">GEAR FOR SPORT</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>EQUIPO</label>
                    <input type="text" id="team-name" placeholder="Escriba el nombre del equipo...">
                </div>
                <div class="input-group">
                    <label>GÉNERO</label>
                    <input type="text" id="gender-input" readonly placeholder="Automático">
                </div>
            </div>
        </section>

        <nav class="placements-nav">
            <div id="tabs-container" class="tabs-scroll"></div>
            <button class="btn-add" onclick="addNewPlacement()">
                <i class="fas fa-plus"></i> Add Placement
            </button>
        </nav>

        <main id="placements-container"></main>
    </div>

    <script src="config.js"></script>
    <script src="config-teams-unified.js"></script>
    <script src="utils.js"></script>
    <script src="validators.js"></script>

    <script>
        let placements = [];

        // 1. GESTIÓN DE NOMBRES
        function getPlacementDisplayName(placement) {
            if (placement.type === 'CUSTOM' && placement.customType) {
                return placement.customType.toUpperCase();
            }
            return placement.type || 'PLACEMENT';
        }

        // 2. ACTUALIZACIÓN DE TÍTULOS DINÁMICOS
        function updateAllPlacementTitles(placementId) {
            const placement = placements.find(p => p.id === placementId);
            if (!placement) return;
            
            const displayType = getPlacementDisplayName(placement);
            const section = document.getElementById(`placement-section-${placementId}`);
            if (!section) return;
            
            // Título Principal
            const title = section.querySelector('.placement-title span');
            if (title) title.textContent = displayType;
            
            // Títulos de Cards (Colores para..., Imagen para...)
            const cardTitles = section.querySelectorAll('.card-title');
            cardTitles.forEach(cardTitle => {
                const text = cardTitle.textContent;
                if (text.includes('Colores')) cardTitle.textContent = `Colores para ${displayType}`;
                else if (text.includes('Imagen')) cardTitle.textContent = `Imagen para ${displayType}`;
                else if (text.includes('Condiciones')) cardTitle.textContent = `Condiciones para ${displayType}`;
            });

            // Título de Secuencia
            const sequenceTitle = section.querySelector('.sequence-main-title');
            if (sequenceTitle) sequenceTitle.textContent = `Secuencia de ${displayType}`;
            
            // Actualizar Tab
            const tab = document.querySelector(`.placement-tab[data-placement-id="${placementId}"]`);
            if (tab) {
                const labelNode = Array.from(tab.childNodes).find(node => node.nodeType === 3 && node.textContent.trim() !== "");
                if (labelNode) labelNode.textContent = ` ${displayType.substring(0, 15)} `;
            }
        }

        // 3. RENDERIZADO DEL PLACEMENT
        function renderPlacementHTML(placement) {
            const container = document.getElementById('placements-container');
            const pId = placement.id;
            const displayType = getPlacementDisplayName(placement);

            const section = document.createElement('div');
            section.id = `placement-section-${pId}`;
            section.className = 'placement-section';
            section.style.display = 'none'; 

            section.innerHTML = `
                <div class="placement-card">
                    <div class="placement-header-main">
                        <h2 class="placement-title"><i class="fas fa-print"></i> <span>${displayType}</span></h2>
                        <div class="placement-controls">
                            <select onchange="updatePlacementType(${pId}, this.value)" class="placement-type-select">
                                <option value="FRONT" ${placement.type === 'FRONT' ? 'selected' : ''}>FRONT</option>
                                <option value="BACK" ${placement.type === 'BACK' ? 'selected' : ''}>BACK</option>
                                <option value="LEFT CHEST" ${placement.type === 'LEFT CHEST' ? 'selected' : ''}>LEFT CHEST</option>
                                <option value="CUSTOM" ${placement.type === 'CUSTOM' ? 'selected' : ''}>CUSTOM...</option>
                            </select>
                            <input type="text" id="custom-placement-input-${pId}" class="custom-type-input" 
                                placeholder="Escriba nombre (ej. SHORT)..." style="display: ${placement.type === 'CUSTOM' ? 'block' : 'none'}"
                                value="${placement.customType || ''}" oninput="updateCustomPlacement(${pId}, this.value)">
                        </div>
                    </div>

                    <div class="placement-grid">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Colores para ${displayType}</h3></div>
                            <div class="card-body">
                                <table class="colors-table">
                                    <thead><tr><th>Color / Pantone</th><th>Ink</th><th>Hex</th><th></th></tr></thead>
                                    <tbody id="colors-body-${pId}"></tbody>
                                </table>
                                <button class="btn-add-row" onclick="addColorRow(${pId})">+ Add Color</button>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Imagen para ${displayType}</h3></div>
                            <div class="card-body">
                                <div class="image-upload-zone" onclick="document.getElementById('file-${pId}').click()">
                                    ${placement.image ? `<img src="${placement.image}" class="preview-img">` : '<p>Subir Arte</p>'}
                                </div>
                                <input type="file" id="file-${pId}" style="display:none" onchange="handleImageUpload(event, ${pId})">
                            </div>
                        </div>
                    </div>

                    <div class="card mt-20">
                        <div class="card-header"><h4 class="sequence-main-title">Secuencia de ${displayType}</h4></div>
                        <div id="stations-container-${pId}" class="stations-table-container"></div>
                    </div>
                </div>
            `;
            container.appendChild(section);
            if (typeof renderColorRows === 'function') renderColorRows(pId);
            if (typeof updatePlacementStations === 'function') updatePlacementStations(pId);
        }

        // 4. FUNCIONES DE CAMBIO DE ESTADO
        function updatePlacementType(placementId, type) {
            const p = placements.find(p => p.id === placementId);
            if (!p) return;
            const customInput = document.getElementById(`custom-placement-input-${placementId}`);
            if (type === 'CUSTOM') {
                if (customInput) customInput.style.display = 'block';
                p.type = 'CUSTOM';
            } else {
                if (customInput) customInput.style.display = 'none';
                p.type = type; p.customType = '';
            }
            setTimeout(() => updateAllPlacementTitles(placementId), 50);
        }

        function updateCustomPlacement(placementId, customName) {
            const p = placements.find(p => p.id === placementId);
            if (p) {
                p.customType = customName.toUpperCase();
                updateAllPlacementTitles(placementId);
            }
        }

        // 5. EXPORTAR PDF (CORREGIDO ANCHO)
        async function exportToPDF() {
            const element = document.querySelector('.app-container');
            const originalStyle = element.style.cssText;
            element.style.width = '1024px'; // Evita que el texto se salga del PDF
            element.style.minWidth = '1024px';
            
            try {
                const canvas = await html2canvas(element, { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const width = pdf.internal.pageSize.getWidth();
                const height = (canvas.height * width) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, width, height);
                pdf.save(`Tegra-Spec-${Date.now()}.pdf`);
            } catch (e) {
                console.error("Error PDF:", e);
            } finally {
                element.style.cssText = originalStyle;
            }
        }

        // INICIALIZACIÓN
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Sistema Tegra cargado.");
            // Aquí puedes llamar a una función para crear el primer placement vacío
        });
    </script>
    <script src="fixes.js"></script>
</body>
</html>
