<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tegra - Technical Spec Manager</title>
  
  <!-- ESTILOS PRIMERO -->
  <link rel="stylesheet" href="styles.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- LIBRER√çAS EXTERNAS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  
  <!-- NUESTROS M√ìDULOS - ORDEN CR√çTICO -->
  <script src="config-teams-unified.js"></script>
  <script src="utils.js"></script>
  <script src="state-manager.js"></script>
  <script src="validators.js"></script>
  <script src="error-handler.js"></script>
  <script src="specialties-detector.js"></script>
  <script src="render-helpers.js"></script>
  <script src="fixes.js"></script>
</head>
<body>
  <div class="app-container">
      <!-- HEADER -->
      <header class="app-header">
          <div class="logo-section">
              <div class="app-logo">
                  <svg viewBox="0 0 145.94 39.05" xmlns="http://www.w3.org/2000/svg">
                      <path d="M42.24,12.37v1.93h6.91v15.25h4.21v-15.25h6.91v-3.88h-16.1l-1.93,1.95ZM92.06,20.31v1.87h4.24v2.73c-.53.38-1.13.67-1.8.86-.67.19-1.39.29-2.16.29-.84,0-1.61.15-2.32-.45-.71-.3-1.33-.72-1.84-1.27-.52-.55-.92-1.19-1.2-1.93-.28-.74-.42-1.54-.42-2.42v-.05c0-.82.14-1.59.42-2.31.28-.72.67-1.35,1.18-1.89.5-.54,1.08-.97,1.75-1.28.66-.32,1.38-.48,2.15-.48.55,0,1.05.05,1.5.14.46.09.88.22,1.27.38.39.16.77.36,1.13.60.25.16.49.34.74.54l2.94-2.97c-.47-.4-.96-.75-1.46-1.07-.53-.33-1.09-.60-1.70-.82-.60-.22-1.25-.39-1.95-.51-.70-.12-1.48-.18-2.34-.18-1.44,0-2.77.26-4,.78-1.23.52-2.29,1.23-3.18,2.13-.89.90-1.59,1.95-2.09,3.14-.50,1.19-.75,2.47-.75,3.84v-.05c0,1.42.25,2.73.74,3.94.49,1.20,1.18,2.24,2.06,3.12.88.87,1.94,1.56,3.17,2.05,1.23.49,2.59.74,4.09.74,1.75,0,3.30-.30,4.66-.89,1.36-.59,2.53-1.31,3.51-2.15v-8.31h-6.56l-1.74,1.76ZM68.15,21.8h9.02v-3.74h-9.02v-3.88h10.25v-3.74h-12.55l0.14,0.14v17.12h14.54v-3.74h-10.53v-4.02ZM114.24,10.43h-8.75v19.13h4.21v-6.12h3.31l4.10,6.12h2.57l1.39-1.40-3.71-5.43c1.22-.46,2.21-1.17,2.97-2.15.76-.97,1.13-2.24,1.13-3.79v-.05c0-1.82-.55-3.28-1.64-4.37-1.29-1.29-3.15-1.94-5.58-1.94ZM117.19,17.03c0,.82-.28,1.48-.83,1.98-.56.49-1.35.74-2.39.74h-4.26v-5.52h4.18c1.04,0,1.85.23,2.43.69.58.46.87,1.14.87,2.06v.05ZM136.7,10.29h-3.88l-8.20,19.27h4.29l1.75-4.29h8.09l1.75,4.29h1.97l1.70-1.72-7.47-17.55ZM132.16,21.58l2.54-6.20,2.54,6.20h-5.08Z"/>
                      <g><polygon points="7.44 31.38 6.59 32.24 6.88 33.39 8.03 33.68 8.89 32.83 8.59 31.68 7.44 31.38"/><polygon points="6.79 28.67 7.94 28.97 10.41 26.5 10.11 25.35 8.96 25.05 6.49 27.52 6.79 28.67"/><polygon points="10.54 14.61 9.4 14.31 6.93 16.78 7.23 17.93 8.37 18.23 10.85 15.76 10.54 14.61"/><polygon points="26.38 22.79 25.06 24.11 25.36 25.26 26.5 25.56 27.82 24.24 27.52 23.09 26.38 22.79"/><path d="M21.9,36.93l.30,1.15,1.15.30.85-.85-.30-1.15-1.15-.30-.85.85ZM18.01,29.21l-.30-1.15.85-.85,1.15.30.30,1.15-.85.85-1.15-.30ZM18.83,19.56l-.30-1.15,1.50-1.50,1.15.30.30,1.15-1.50,1.50-1.15-.30ZM20.85,14.61l-.30-1.15,1.50-1.50,1.15.30.30,1.15-1.50,1.50-1.15-.30ZM14.33,15.34l-.30-1.14,3.78-3.68,1.14.30.30,1.14-3.78,3.68-1.15-.30ZM24.21,10.68l-.30-1.15,2.17-2.17,1.14.30.30,1.14-2.17,2.17-1.14-.30ZM20.59,9.12l-.30-1.15.85-.85,1.15.30.30,1.15-.85.85-1.15-.30ZM15.06,8.82l-.30-1.15,1.50-1.50,1.15.30.30,1.15-1.50,1.50-1.15-.30ZM25.51,0l-4.90,4.90-1.14-.30-.30-1.14,3.46-3.46H0v9.55h4.54l-1.67,1.67.30,1.14,1.15.30,3.12-3.12h.02l2.59-2.59,1.14.30.30,1.14-.57.57-1.81,1.78.30,1.15,1.15.30,2.50-2.45v8.41l-3.99,3.99.30,1.15,1.15.30,4.62-4.62,1.07.28.30,1.15-1.42,1.42-.93.93-.84.84-1.78,1.78.30,1.15,1.14.30,3.56-3.56.27-.27,1.14.30.30,1.14-4.64,4.64h-.03s-2.52,2.51-2.52,2.51l.31,1.16,1.17.31,2.52-2.52h0s.30-.32.30-.32l1.14.30.30,1.15-3.75,3.75h0s-2.17,2.18-2.17,2.18l.30,1.14,1.15.30,6.35-6.35,1.14.30.30,1.15-2.82,2.77.30,1.14,1.15.30,5.15-5.10v-2.89h0s-1.24,1.24-1.24,1.24l-1.15-.30-.30-1.14,3.43-3.41-.30-1.15-.45-.12-.71-.19-1.05,1.05-1.14-.30-.30-1.14,6.16-6.31-.30-1.15-1.14-.30-1.51,1.51v-4.34l5.25-4.76h7.28V0h-10.92Z"/></g>
                  </svg>
              </div>
              <div>
                  <h1 class="app-title">Technical Spec Manager</h1>
                  <p class="app-subtitle">Sistema de gesti√≥n de especificaciones t√©cnicas</p>
              </div>
              <div class="theme-toggle">
                  <button id="themeToggle" class="theme-toggle-btn">
                      <i class="fas fa-sun"></i> Modo Claro
                  </button>
              </div>
          </div>

          <div class="client-section">
              <span class="client-label">CUSTOMER / CLIENTE:</span>
              <div class="client-logo-wrapper">
                  <img id="logoCliente" alt="Logo del cliente" style="max-height: 35px; max-width: 120px; display: none;">
              </div>
          </div>

          <div class="header-actions">
              <div class="folder-input-container">
                  <span class="client-label" style="font-size: 0.9rem; color: White;"># FOLDER:</span>
                  <input type="text" id="folder-num" class="form-control" placeholder="#####">
              </div>
              <div id="current-datetime"></div>
          </div>
      </header>

      <!-- NAVIGATION -->
      <nav class="app-nav no-print">
          <ul class="nav-tabs">
              <li class="nav-tab active" onclick="showTab('dashboard')">
                  <i class="fas fa-tachometer-alt"></i> Dashboard
              </li>
              <li class="nav-tab" onclick="showTab('spec-creator')">
                  <i class="fas fa-file-alt"></i> Crear Spec
              </li>
              <li class="nav-tab" onclick="showTab('saved-specs')">
                  <i class="fas fa-database"></i> Guardadas
              </li>
              <li class="nav-tab" onclick="showTab('error-log')">
                  <i class="fas fa-exclamation-triangle"></i> Log de Errores
              </li>
          </ul>
      </nav>

      <!-- MAIN CONTENT -->
      <main class="app-main">

          <!-- TAB: DASHBOARD -->
          <div id="dashboard" class="tab-content active">
              <div class="dashboard-grid">
                  <div class="stat-card">
                      <div class="stat-number" id="total-specs">0</div>
                      <div class="stat-label">Specs Totales</div>
                  </div>
                  <div class="stat-card">
                      <div id="today-specs">
                          <div style="font-size:0.9rem; color:var(--text-secondary);">√öltima Spec:</div>
                          <div style="font-size:1.2rem; font-weight:bold; color:var(--primary);">Ninguna</div>
                          <div style="font-size:0.8rem; color:var(--text-secondary);">-</div>
                      </div>
                      <div class="stat-label">√öltima Creaci√≥n</div>
                  </div>
                  <div class="stat-card">
                      <div class="stat-number" id="active-projects">0</div>
                      <div class="stat-label">Proyectos Activos</div>
                  </div>
                  <div class="stat-card">
                      <div id="completion-rate">
                          <div style="font-size:0.9rem; color:var(--text-secondary);">Placements totales:</div>
                          <div style="font-size:1.5rem; font-weight:bold; color:var(--primary);">0</div>
                      </div>
                      <div class="stat-label">Placements Totales</div>
                  </div>
              </div>

              <div class="card">
                  <div class="card-header">
                      <h2 class="card-title"><i class="fas fa-rocket"></i> Acciones R√°pidas</h2>
                  </div>
                  <div class="card-body" style="text-align:center;">
                      <div style="margin-top:20px; display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
                          <button class="btn btn-primary btn-lg" onclick="showTab('spec-creator')">
                              <i class="fas fa-plus"></i> Nueva Spec
                          </button>
                          <button class="btn btn-warning btn-lg" onclick="document.getElementById('excelFile').click()">
                              <i class="fas fa-folder-open"></i> Cargar Spec
                          </button>
                          <button class="btn btn-success btn-lg" onclick="document.getElementById('excelFile').click()">
                              <i class="fas fa-file-excel"></i> Cargar SWO
                          </button>
                          <button class="btn btn-outline btn-lg" onclick="loadSavedSpecsList(); showTab('saved-specs')">
                              <i class="fas fa-history"></i> Ver Historial
                          </button>
                          <button class="btn btn-danger btn-lg" onclick="showTab('error-log')">
                              <i class="fas fa-bug"></i> Ver Errores
                          </button>
                      </div>
                  </div>
              </div>
          </div>

          <!-- TAB: SPEC CREATOR -->
          <div id="spec-creator" class="tab-content">
              <!-- INFORMACI√ìN GENERAL -->
              <div class="card">
                  <div class="card-header">
                      <h2 class="card-title"><i class="fas fa-info-circle"></i> Informaci√≥n General</h2>
                  </div>
                  <div class="card-body">
                      <div class="form-grid">
                          <div class="form-group">
                              <label class="form-label">CLIENTE:</label>
                              <input type="text" id="customer" class="form-control" oninput="updateClientLogo()">
                          </div>
                          <div class="form-group">
                              <label class="form-label">STYLE:</label>
                              <input type="text" id="style" class="form-control">
                          </div>
                          <div class="form-group">
                              <label class="form-label">COLORWAY:</label>
                              <input type="text" id="colorway" class="form-control">
                          </div>
                          <div class="form-group">
                              <label class="form-label">SEASON:</label>
                              <input type="text" id="season" class="form-control">
                          </div>
                          <div class="form-group">
                              <label class="form-label">PATTERN #:</label>
                              <input type="text" id="pattern" class="form-control">
                          </div>
                          <div class="form-group">
                              <label class="form-label">P.O. #:</label>
                              <input type="text" id="po" class="form-control">
                          </div>
                          <div class="form-group">
                              <label class="form-label">SAMPLE TYPE:</label>
                              <input type="text" id="sample-type" class="form-control">
                          </div>
                          <div class="form-group">
                              <label class="form-label">NAME / TEAM:</label>
                              <input type="text" id="name-team" class="form-control">
                          </div>
                          <div class="form-group">
                              <label class="form-label">GENDER:</label>
                              <input type="text" id="gender" class="form-control">
                          </div>
                          <div class="form-group">
                              <label class="form-label">DISE√ëADOR:</label>
                              <select id="designer" class="form-control">
                                  <option value="">Seleccionar...</option>
                                  <option value="ELMER VELEZ">ELMER VELEZ</option>
                                  <option value="DANIEL HERNANDEZ">DANIEL HERNANDEZ</option>
                                  <option value="CINDY PINEDA">CINDY PINEDA</option>
                                  <option value="FERNANDO FERRERA">FERNANDO FERRERA</option>
                                  <option value="NILDA CORDOBA">NILDA CORDOBA</option>
                                  <option value="OTRO">OTRO</option>
                              </select>
                          </div>
                      </div>
                  </div>
              </div>

              <!-- SISTEMA DE M√öLTIPLES PLACEMENTS -->
              <div class="card">
                  <div class="card-header">
                      <h2 class="card-title"><i class="fas fa-layer-group"></i> Ubicaciones (Placements)</h2>
                      <div class="no-print">
                          <button class="btn btn-primary btn-sm" onclick="addNewPlacement()">
                              <i class="fas fa-plus"></i> Agregar Placement
                          </button>
                      </div>
                  </div>
                  <div class="card-body">
                      <!-- Contenedor de tabs para placements -->
                      <div id="placements-tabs" class="placement-tabs">
                          <!-- Tabs se generar√°n din√°micamente -->
                      </div>
                      
                      <!-- Contenedor principal de placements -->
                      <div id="placements-container">
                          <!-- Cada placement ser√° una secci√≥n dentro de este contenedor -->
                      </div>
                  </div>
              </div>

              <!-- BOTONES DE ACCI√ìN -->
              <div class="card no-print">
                  <div class="card-body" style="display:flex; gap:15px; flex-wrap:wrap; justify-content:center;">
                      <button class="btn btn-primary btn-lg" onclick="exportToExcel()">
                          <i class="fas fa-file-excel"></i> Descargar Spec
                      </button>
                      <button class="btn btn-success btn-lg" onclick="exportPDF()">
                          <i class="fas fa-file-pdf"></i> Exportar PDF
                      </button>
                      <button class="btn btn-primary btn-lg" onclick="saveCurrentSpec()">
                          <i class="fas fa-save"></i> Guardar Spec
                      </button>
                      <button class="btn btn-outline btn-lg" onclick="clearForm()">
                          <i class="fas fa-broom"></i> Limpiar
                      </button>
                  </div>
              </div>
          </div>

          <!-- TAB: SPECS GUARDADAS -->
          <div id="saved-specs" class="tab-content">
              <div class="card">
                  <div class="card-header">
                      <h2 class="card-title"><i class="fas fa-database"></i> Specs Guardadas (Browser)</h2>
                      <button class="btn btn-outline btn-sm" onclick="clearAllSpecs()">
                          <i class="fas fa-trash"></i> Limpiar Todo
                      </button>
                  </div>
                  <div class="card-body" id="saved-specs-list">
                      <p style="text-align:center; color:var(--text-secondary); padding:20px;">
                          <i class="fas fa-database" style="font-size:2rem; margin-bottom:10px; display:block;"></i>
                          No hay specs guardadas. Crea una nueva spec para verla aqu√≠.
                      </p>
                  </div>
              </div>
          </div>

          <!-- TAB: LOG DE ERRORES -->
          <div id="error-log" class="tab-content">
              <div class="card">
                  <div class="card-header">
                      <h2 class="card-title"><i class="fas fa-exclamation-triangle"></i> Log de Errores</h2>
                  </div>
                  <div class="card-body">
                      <div id="error-log-content">
                          <!-- Los errores se cargar√°n aqu√≠ din√°micamente -->
                      </div>
                  </div>
              </div>
          </div>
      </main>

      <div id="statusMessage" class="status-message"></div>
  </div>

  <!-- Inputs ocultos -->
  <input type="file" id="excelFile" accept=".xlsx, .xls, .json, .zip" style="display: none;">
  <input type="file" id="placementImageInput" accept="image/*" style="display: none;">

  <!-- JavaScript principal -->
  <script>
// ========== VARIABLES GLOBALES ==========
window.placements = [];
let currentPlacementId = 1;
let isDarkMode = true;

// ========== FIX PARA UTILS NO CARGADO ==========
if (typeof Utils === 'undefined') {
    console.log('‚ö†Ô∏è Utils no est√° cargado, creando versi√≥n m√≠nima...');
    window.Utils = {
        getInkPreset: function(inkType = 'WATER') {
            const defaults = {
                'WATER': { 
                    temp: '320 ¬∞F', 
                    time: '1:40 min',
                    blocker: { name: 'BLOCKER CHT', mesh1: '122/55', mesh2: '157/48', durometer: '70', speed: '35', angle: '15', strokes: '2', pressure: '40', additives: 'N/A' },
                    white: { name: 'AQUAFLEX WHITE', mesh1: '198/40', mesh2: '157/48', durometer: '70', speed: '35', angle: '15', strokes: '2', pressure: '40', additives: 'N/A' },
                    color: { mesh: '157/48', durometer: '70', speed: '35', angle: '15', strokes: '2', pressure: '40', additives: '3 % cross-linker 500 ¬∑ 1.5 % antitack' }
                },
                'PLASTISOL': { 
                    temp: '320 ¬∞F', 
                    time: '1:00 min',
                    blocker: { name: 'BLOCKER plastisol', mesh1: '110/64', mesh2: '156/64', durometer: '65', speed: '35', angle: '15', strokes: '1', pressure: '40', additives: 'N/A' },
                    white: { name: 'PLASTISOL WHITE', mesh1: '156/64', mesh2: '110/64', durometer: '65', speed: '35', angle: '15', strokes: '2', pressure: '40', additives: 'N/A' },
                    color: { mesh: '156/64', durometer: '65', speed: '35', angle: '15', strokes: '1', pressure: '40', additives: '1 % catalyst' }
                },
                'SILICONE': { 
                    temp: '320 ¬∞F', 
                    time: '1:00 min',
                    blocker: { name: 'Bloquer Libra', mesh1: '110/64', mesh2: '157/48', durometer: '70', speed: '35', angle: '15', strokes: '2', pressure: '40', additives: 'N/A' },
                    white: { name: 'White Libra', mesh1: '122/55', mesh2: '157/48', durometer: '70', speed: '35', angle: '15', strokes: '2', pressure: '40', additives: 'N/A' },
                    color: { mesh: '157/48', durometer: '70', speed: '35', angle: '15', strokes: '2', pressure: '40', additives: '3 % cat ¬∑ 2 % ret' }
                }
            };
            return defaults[inkType] || defaults.WATER;
        },
        
        getColorHex: function(colorName) {
            if (!colorName) return null;
            
            const name = colorName.toUpperCase().trim();
            
            // Buscar c√≥digo hex directo
            const hexMatch = name.match(/#([0-9A-F]{6})/i);
            if (hexMatch) {
                return `#${hexMatch[1]}`;
            }
            
            // Algunos colores b√°sicos
            const basicColors = {
                'WHITE': '#FFFFFF',
                'BLACK': '#000000',
                'RED': '#FF0000',
                'GREEN': '#00FF00',
                'BLUE': '#0000FF',
                'YELLOW': '#FFFF00',
                'ORANGE': '#FFA500',
                'PURPLE': '#800080',
                'GRAY': '#808080',
                'GOLD': '#FFD700',
                'SILVER': '#C0C0C0',
                'BROWN': '#A52A2A',
                'PINK': '#FFC0CB',
                'CYAN': '#00FFFF',
                'MAGENTA': '#FF00FF',
                'LIME': '#00FF00',
                'MAROON': '#800000',
                'OLIVE': '#808000',
                'NAVY': '#000080',
                'TEAL': '#008080',
                'AQUA': '#00FFFF',
                'FUCHSIA': '#FF00FF'
            };
            
            if (basicColors[name]) {
                return basicColors[name];
            }
            
            return null;
        },
        
        detectTeamFromStyle: function(style) {
            if (!style) return '';
            const styleStr = style.toString().toUpperCase().trim();
            
            // Buscar en Config si existe
            if (window.Config && window.Config.TEAM_CODE_MAP) {
                for (const [code, teamName] of Object.entries(window.Config.TEAM_CODE_MAP)) {
                    if (styleStr.includes(code)) {
                        return teamName;
                    }
                }
            }
            
            return '';
        },
        
        extractGenderFromStyle: function(style) {
            if (!style) return '';
            const styleStr = style.toString().toUpperCase().trim();
            
            if (styleStr.includes(' MEN') || styleStr.includes('_M') || styleStr.endsWith('M')) return 'Men';
            if (styleStr.includes(' WOMEN') || styleStr.includes('_W') || styleStr.endsWith('W')) return 'Women';
            if (styleStr.includes(' YOUTH') || styleStr.includes('_Y') || styleStr.endsWith('Y')) return 'Youth';
            if (styleStr.includes(' KIDS') || styleStr.includes('_K') || styleStr.endsWith('K')) return 'Kids';
            if (styleStr.includes(' UNISEX') || styleStr.includes('_U') || styleStr.endsWith('U')) return 'Unisex';
            if (styleStr.includes(' BOYS') || styleStr.includes('_B') || styleStr.endsWith('B')) return 'Boys';
            if (styleStr.includes(' GIRLS') || styleStr.includes('_G') || styleStr.endsWith('G')) return 'Girls';
            
            return '';
        }
    };
}

// ========== FUNCIONES AUXILIARES ==========
function updateDateTime() {
    const now = new Date();
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
    };
    document.getElementById('current-datetime').textContent = 
        now.toLocaleDateString('es-ES', options);
}

function showStatus(msg, type = 'success') {
    const el = document.getElementById('statusMessage');
    el.textContent = msg;
    el.className = `status-message status-${type}`;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 4000);
}

// ========== FUNCIONES DE TEMA ==========
function toggleTheme() {
    isDarkMode = !isDarkMode;
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    
    if (isDarkMode) {
        body.classList.remove('light-mode');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i> Modo Claro';
        showStatus('üåô Modo oscuro activado');
    } else {
        body.classList.add('light-mode');
        themeToggle.innerHTML = '<i class="fas fa-moon"></i> Modo Oscuro';
        showStatus('‚òÄÔ∏è Modo claro activado');
    }
    
    localStorage.setItem('tegraspec-theme', isDarkMode ? 'dark' : 'light');
}

function loadThemePreference() {
    const savedTheme = localStorage.getItem('tegraspec-theme');
    const themeToggle = document.getElementById('themeToggle');
    
    if (savedTheme === 'light') {
        isDarkMode = false;
        document.body.classList.add('light-mode');
        themeToggle.innerHTML = '<i class="fas fa-moon"></i> Modo Oscuro';
    } else {
        isDarkMode = true;
        themeToggle.innerHTML = '<i class="fas fa-sun"></i> Modo Claro';
    }
}

// ========== FUNCIONES DE NAVEGACI√ìN ==========
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    
    const tabs = document.querySelectorAll('.nav-tab');
    tabs.forEach(tab => {
        if (tab.innerText.toLowerCase().includes(tabName.replace('-', ' '))) {
            tab.classList.add('active');
        }
    });
    
    if (tabName === 'saved-specs') loadSavedSpecsList();
    if (tabName === 'dashboard') updateDashboard();
    if (tabName === 'error-log') loadErrorLog();
    if (tabName === 'spec-creator') {
        if (placements.length === 0) {
            initializePlacements();
        }
    }
}

// ========== FUNCI√ìN SETUP PASTE HANDLER ==========
function setupPasteHandler() {
    document.addEventListener('paste', function(e) {
        const activePlacement = document.querySelector('.placement-section.active');
        if (!activePlacement) return;
        
        const items = e.clipboardData.items;
        
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const blob = items[i].getAsFile();
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    const placementId = activePlacement.dataset.placementId;
                    const placement = placements.find(p => p.id === parseInt(placementId));
                    
                    if (placement) {
                        placement.imageData = event.target.result;
                        
                        const img = document.getElementById(`placement-image-preview-${placementId}`);
                        const imageActions = document.getElementById(`placement-image-actions-${placementId}`);
                        
                        if (img && imageActions) {
                            img.src = event.target.result;
                            img.style.display = 'block';
                            imageActions.style.display = 'flex';
                        }
                        
                        showStatus(`‚úÖ Imagen pegada en ${placement.type}`);
                    }
                };
                
                reader.readAsDataURL(blob);
                e.preventDefault();
                break;
            }
        }
    });
}

// ========== FUNCI√ìN ACTUALIZADA updateClientLogo ==========
function updateClientLogo() {
    const customer = document.getElementById('customer').value.toUpperCase().trim();
    const logoElement = document.getElementById('logoCliente');
    if (!logoElement) return;
    
    let logoUrl = '';
    
    const gfsVariations = ['GEAR FOR SPORT', 'GEARFORSPORT', 'GFS', 'G.F.S.', 'G.F.S', 'GEAR', 'G-F-S'];
    const isGFS = gfsVariations.some(variation => customer.includes(variation));
    
    if (customer.includes('NIKE') || customer.includes('NIQUE')) {
        logoUrl = 'https://raw.githubusercontent.com/veleztegra-create/costos/refs/heads/main/Nike-Logotipo-PNG-Photo.png';
    } else if (customer.includes('FANATICS') || customer.includes('FANATIC')) {
        logoUrl = 'https://raw.githubusercontent.com/veleztegra-create/costos/refs/heads/main/Fanatics_company_logo.svg.png';
    } else if (customer.includes('ADIDAS')) {
        logoUrl = 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/20/Adidas_Logo.svg/1280px-Adidas_Logo.svg.png';
    } else if (customer.includes('PUMA')) {
        logoUrl = 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/Puma_Logo.svg/1280px-Puma_Logo.svg.png';
    } else if (customer.includes('UNDER ARMOUR') || customer.includes('UA')) {
        logoUrl = 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/44/Under_armour_logo.svg/1280px-Under_armour_logo.svg.png';
    } else if (isGFS) {
        logoUrl = 'https://raw.githubusercontent.com/veleztegra-create/costos/refs/heads/main/SVG.png';
    }
    
    if (logoUrl) {
        logoElement.src = logoUrl;
        logoElement.style.display = 'block';
    } else {
        logoElement.style.display = 'none';
    }
}

// ========== FUNCI√ìN PARA ACTUALIZAR T√çTULO DE COLORES ==========
function updatePlacementColorTitle(placementId) {
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return;
    
    const displayType = placement.type.includes('CUSTOM:') 
        ? placement.type.replace('CUSTOM: ', '')
        : placement.type;
    
    const colorTitle = document.querySelector(`#placement-section-${placementId} .card-title`);
    if (colorTitle && colorTitle.textContent.includes('Colores')) {
        colorTitle.textContent = `Colores para ${displayType}`;
    }
}

// ========== FUNCIONES PARA M√öLTIPLES PLACEMENTS ==========
function initializePlacements() {
    const firstPlacementId = addNewPlacement('FRONT', true);
    
    if (placements.length > 0) {
        renderPlacementHTML(placements[0]);
    }
    
    updatePlacementsTabs();
    showPlacement(firstPlacementId);
}

function addNewPlacement(type = null, isFirst = false) {
    const placementId = isFirst ? 1 : Date.now();
    const placementType = type || getNextPlacementType();
    
    // USAR UTILS SI EXISTE, SINO VALORES POR DEFECTO
    const preset = Utils.getInkPreset('WATER');
    
    const newPlacement = {
        id: placementId,
        type: placementType,
        name: placementType,
        imageData: null,
        colors: [],
        placementDetails: '#.#" FROM COLLAR SEAM',
        dimensions: 'SIZE: (W) ##" X (H) ##"',
        temp: preset.temp,
        time: preset.time,
        specialties: '',
        specialInstructions: '',
        inkType: 'WATER',
        placementSelect: 'FRONT',
        isActive: true,
        meshColor: preset.color.mesh,
        meshWhite: preset.white.mesh1,
        meshBlocker: preset.blocker.mesh1,
        durometer: preset.color.durometer,
        strokes: preset.color.strokes,
        angle: preset.color.angle,
        pressure: preset.color.pressure,
        speed: preset.color.speed,
        additives: preset.color.additives,
        width: '',
        height: ''
    };
    
    if (!isFirst) {
        placements.push(newPlacement);
    } else {
        placements = [newPlacement];
    }
    
    if (!isFirst) {
        renderPlacementHTML(newPlacement);
        showPlacement(placementId);
        updatePlacementsTabs();
    }
    
    return placementId;
}

function getNextPlacementType() {
    const usedTypes = placements.map(p => p.type);
    const allTypes = ['FRONT', 'BACK', 'SLEEVE', 'CHEST', 'TV. NUMBERS', 'SHOULDER', 'COLLAR', 'CUSTOM'];
    
    for (const type of allTypes) {
        if (!usedTypes.includes(type)) {
            return type;
        }
    }
    return 'CUSTOM';
}

// ========== RENDER PLACEMENT HTML ==========
function renderPlacementHTML(placement) {
    const container = document.getElementById('placements-container');
    
    if (document.getElementById(`placement-section-${placement.id}`)) {
        return;
    }
    
    const sectionId = `placement-section-${placement.id}`;
    const isCustom = placement.type.includes('CUSTOM:');
    const displayType = isCustom ? 'CUSTOM' : placement.type;
    const customName = isCustom ? placement.type.replace('CUSTOM: ', '') : '';
    
    const preset = Utils.getInkPreset(placement.inkType || 'WATER');
    
    const defaultMeshColor = preset.color.mesh || '157/48';
    const defaultMeshWhite = preset.white.mesh1 || '198/40';
    const defaultMeshBlocker = preset.blocker.mesh1 || '122/55';
    const defaultDurometer = preset.color.durometer || '70';
    const defaultStrokes = preset.color.strokes || '2';
    const defaultAngle = preset.color.angle || '15';
    const defaultPressure = preset.color.pressure || '40';
    const defaultSpeed = preset.color.speed || '35';
    const defaultAdditives = preset.color.additives || '3 % cross-linker 500 ¬∑ 1.5 % antitack';
    
    const dimensions = extractDimensions(placement.dimensions);
    
    const sectionHTML = `
        <div id="${sectionId}" class="placement-section" data-placement-id="${placement.id}">
            <div class="placement-header">
                <div class="placement-title">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>${displayType}</span>
                </div>
                <div class="placement-actions">
                    <button class="btn btn-outline btn-sm" onclick="duplicatePlacement(${placement.id})">
                        <i class="fas fa-copy"></i> Duplicar
                    </button>
                    ${placements.length > 1 ? `
                    <button class="btn btn-danger btn-sm" onclick="removePlacement(${placement.id})">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                    ` : ''}
                </div>
            </div>
            
            <div class="placement-grid">
                <div class="placement-left-column">
                    <!-- Tipo de Placement -->
                    <div class="form-group">
                        <label class="form-label">TIPO DE PLACEMENT:</label>
                        <select class="form-control placement-type-select" 
                                data-placement-id="${placement.id}"
                                onchange="updatePlacementType(${placement.id}, this.value)">
                            <option value="FRONT" ${placement.type === 'FRONT' || displayType === 'FRONT' ? 'selected' : ''}>FRONT (Frente)</option>
                            <option value="BACK" ${placement.type === 'BACK' || displayType === 'BACK' ? 'selected' : ''}>BACK (Espalda)</option>
                            <option value="SLEEVE" ${placement.type === 'SLEEVE' || displayType === 'SLEEVE' ? 'selected' : ''}>SLEEVE (Manga)</option>
                            <option value="CHEST" ${placement.type === 'CHEST' || displayType === 'CHEST' ? 'selected' : ''}>CHEST (Pecho)</option>
                            <option value="TV. NUMBERS" ${placement.type === 'TV. NUMBERS' || displayType === 'TV. NUMBERS' ? 'selected' : ''}>TV. NUMBERS (N√∫meros TV)</option>
                            <option value="SHOULDER" ${placement.type === 'SHOULDER' || displayType === 'SHOULDER' ? 'selected' : ''}>SHOULDER (Hombro)</option>
                            <option value="COLLAR" ${placement.type === 'COLLAR' || displayType === 'COLLAR' ? 'selected' : ''}>COLLAR (Cuello)</option>
                            <option value="CUSTOM" ${isCustom ? 'selected' : ''}>CUSTOM (Personalizado)</option>
                        </select>
                    </div>
                    
                    <!-- Input para custom placement -->
                    <div id="custom-placement-input-${placement.id}" style="display:${isCustom ? 'block' : 'none'}; margin-top:10px;">
                        <label class="form-label">NOMBRE DEL PLACEMENT:</label>
                        <input type="text" 
                               class="form-control custom-placement-name"
                               data-placement-id="${placement.id}"
                               placeholder="Escribe el nombre del placement personalizado..."
                               value="${customName}"
                               oninput="updateCustomPlacement(${placement.id}, this.value)">
                    </div>
                    
                    <!-- Imagen de Referencia -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title" style="font-size: 1rem;">
                                <i class="fas fa-image"></i> Imagen para ${displayType}
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="file-upload-area" onclick="openImagePickerForPlacement(${placement.id})">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Haz clic para subir una imagen para este placement</p>
                                <p style="font-size:0.8rem; color:var(--text-secondary);">Ctrl+V para pegar</p>
                            </div>
                            <div class="image-preview-container">
                                <img id="placement-image-preview-${placement.id}" 
                                     class="image-preview placement-image" 
                                     alt="Vista previa"
                                     style="display: none;">
                                <div class="image-actions" id="placement-image-actions-${placement.id}" style="display:none;">
                                    <button class="btn btn-danger btn-sm" onclick="removePlacementImage(${placement.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Condiciones de Impresi√≥n -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title" style="font-size: 1rem;">
                                <i class="fas fa-print"></i> Condiciones para ${displayType}
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">DETALLES DE UBICACI√ìN:</label>
                                    <input type="text" 
                                           id="placement-details-${placement.id}"
                                           class="form-control placement-details"
                                           value="${placement.placementDetails}"
                                           oninput="updatePlacementField(${placement.id}, 'placementDetails', this.value)">
                                </div>
                                
                                <!-- Dimensiones separadas -->
                                <div class="form-group">
                                    <label class="form-label">DIMENSIONES:</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="text" 
                                               id="dimension-w-${placement.id}"
                                               class="form-control placement-dimension-w"
                                               placeholder="Ancho"
                                               value="${placement.width || dimensions.width.replace('"', '')}"
                                               oninput="updatePlacementDimension(${placement.id}, 'width', this.value)"
                                               style="width: 100px;">
                                        <span style="color: var(--text-secondary);">X</span>
                                        <input type="text" 
                                               id="dimension-h-${placement.id}"
                                               class="form-control placement-dimension-h"
                                               placeholder="Alto"
                                               value="${placement.height || dimensions.height.replace('"', '')}"
                                               oninput="updatePlacementDimension(${placement.id}, 'height', this.value)"
                                               style="width: 100px;">
                                        <span style="color: var(--text-secondary);">pulgadas</span>
                                    </div>
                                </div>
                                
                                <!-- Campos de temperatura y tiempo -->
                                <div class="form-group">
                                    <label class="form-label">TEMPERATURA:</label>
                                    <input type="text" 
                                           id="temp-${placement.id}"
                                           class="form-control placement-temp"
                                           value="${placement.temp}"
                                           readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">TIEMPO:</label>
                                    <input type="text" 
                                           id="time-${placement.id}"
                                           class="form-control placement-time"
                                           value="${placement.time}"
                                           readonly>
                                </div>
                                
                                <!-- CAMPO SPECIALTIES -->
                                <div class="form-group">
                                    <label class="form-label">SPECIALTIES:</label>
                                    <input type="text" 
                                           id="specialties-${placement.id}"
                                           class="form-control placement-specialties"
                                           placeholder="Detectado autom√°ticamente..."
                                           value="${placement.specialties || ''}"
                                           readonly
                                           title="Detectado autom√°ticamente de los colores">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Par√°metros de Impresi√≥n Editables -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title" style="font-size: 1rem;">
                                <i class="fas fa-sliders-h"></i> Par√°metros de Impresi√≥n
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">MALLA COLORES:</label>
                                    <input type="text" 
                                           id="mesh-color-${placement.id}"
                                           class="form-control placement-mesh-color"
                                           value="${placement.meshColor || defaultMeshColor}"
                                           oninput="updatePlacementParam(${placement.id}, 'meshColor', this.value)">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">MALLA WHITE BASE:</label>
                                    <input type="text" 
                                           id="mesh-white-${placement.id}"
                                           class="form-control placement-mesh-white"
                                           value="${placement.meshWhite || defaultMeshWhite}"
                                           oninput="updatePlacementParam(${placement.id}, 'meshWhite', this.value)">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">MALLA BLOCKER:</label>
                                    <input type="text" 
                                           id="mesh-blocker-${placement.id}"
                                           class="form-control placement-mesh-blocker"
                                           value="${placement.meshBlocker || defaultMeshBlocker}"
                                           oninput="updatePlacementParam(${placement.id}, 'meshBlocker', this.value)">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">DUR√ìMETRO:</label>
                                    <input type="text" 
                                           id="durometer-${placement.id}"
                                           class="form-control placement-durometer"
                                           value="${placement.durometer || defaultDurometer}"
                                           oninput="updatePlacementParam(${placement.id}, 'durometer', this.value)">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">STROKES:</label>
                                    <input type="text" 
                                           id="strokes-${placement.id}"
                                           class="form-control placement-strokes"
                                           value="${placement.strokes || defaultStrokes}"
                                           oninput="updatePlacementParam(${placement.id}, 'strokes', this.value)">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">ANGLE:</label>
                                    <input type="text" 
                                           id="angle-${placement.id}"
                                           class="form-control placement-angle"
                                           value="${placement.angle || defaultAngle}"
                                           oninput="updatePlacementParam(${placement.id}, 'angle', this.value)">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">PRESSURE:</label>
                                    <input type="text" 
                                           id="pressure-${placement.id}"
                                           class="form-control placement-pressure"
                                           value="${placement.pressure || defaultPressure}"
                                           oninput="updatePlacementParam(${placement.id}, 'pressure', this.value)">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">SPEED:</label>
                                    <input type="text" 
                                           id="speed-${placement.id}"
                                           class="form-control placement-speed"
                                           value="${placement.speed || defaultSpeed}"
                                           oninput="updatePlacementParam(${placement.id}, 'speed', this.value)">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">ADITIVOS:</label>
                                    <input type="text" 
                                           id="additives-${placement.id}"
                                           class="form-control placement-additives"
                                           value="${placement.additives || defaultAdditives}"
                                           oninput="updatePlacementParam(${placement.id}, 'additives', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="placement-right-column">
                    <!-- Tipo de Tinta -->
                    <div class="form-group">
                        <label class="form-label">TIPO DE TINTA:</label>
                        <select class="form-control placement-ink-type"
                                data-placement-id="${placement.id}"
                                onchange="updatePlacementInkType(${placement.id}, this.value)">
                            <option value="WATER" ${placement.inkType === 'WATER' ? 'selected' : ''}>Water-base</option>
                            <option value="PLASTISOL" ${placement.inkType === 'PLASTISOL' ? 'selected' : ''}>Plastisol</option>
                            <option value="SILICONE" ${placement.inkType === 'SILICONE' ? 'selected' : ''}>Silicone</option>
                        </select>
                    </div>
                    
                    <!-- Colores y Tintas -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title" style="font-size: 1rem;">
                                <i class="fas fa-palette"></i> Colores para ${displayType}
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="no-print" style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
                                <button class="btn btn-danger btn-sm" onclick="addPlacementColorItem(${placement.id}, 'BLOCKER')">
                                    <i class="fas fa-plus"></i> Blocker
                                </button>
                                <button class="btn btn-white-base btn-sm" onclick="addPlacementColorItem(${placement.id}, 'WHITE_BASE')">
                                    <i class="fas fa-plus"></i> White Base
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="addPlacementColorItem(${placement.id}, 'COLOR')">
                                    <i class="fas fa-plus"></i> Color
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="addPlacementColorItem(${placement.id}, 'METALLIC')">
                                    <i class="fas fa-star"></i> Met√°lico
                                </button>
                            </div>
                            <div id="placement-colors-container-${placement.id}" class="color-sequence"></div>
                        </div>
                    </div>
                    
                    <!-- Instrucciones Especiales -->
                    <div class="form-group">
                        <label class="form-label">INSTRUCCIONES ESPECIALES:</label>
                        <textarea id="special-instructions-${placement.id}"
                                  class="form-control placement-special-instructions"
                                  rows="3"
                                  placeholder="Instrucciones especiales para este placement..."
                                  oninput="updatePlacementField(${placement.id}, 'specialInstructions', this.value)">${placement.specialInstructions}</textarea>
                    </div>
                    
                    <!-- Vista previa de colores -->
                    <div id="placement-colors-preview-${placement.id}" class="color-legend"></div>
                    
                    <!-- Secuencia de Estaciones -->
                    <h4 style="margin:15px 0 10px; font-size:0.9rem; color:var(--primary);">
                        <i class="fas fa-list-ol"></i> Secuencia de ${displayType}
                    </h4>
                    <div id="placement-sequence-table-${placement.id}"></div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML += sectionHTML;
    
    renderPlacementColors(placement.id);
    updatePlacementStations(placement.id);
    updatePlacementColorsPreview(placement.id);
    updatePlacementColorTitle(placement.id);
    
    if (placement.imageData) {
        const img = document.getElementById(`placement-image-preview-${placement.id}`);
        const imageActions = document.getElementById(`placement-image-actions-${placement.id}`);
        
        if (img && imageActions) {
            img.src = placement.imageData;
            img.style.display = 'block';
            imageActions.style.display = 'flex';
        }
    }
}

function updatePlacementsTabs() {
    const tabsContainer = document.getElementById('placements-tabs');
    tabsContainer.innerHTML = '';
    
    placements.forEach(placement => {
        const displayType = placement.type.includes('CUSTOM:') 
            ? placement.type.replace('CUSTOM: ', '')
            : placement.type;
            
        const tab = document.createElement('div');
        tab.className = `placement-tab ${placement.id === currentPlacementId ? 'active' : ''}`;
        tab.setAttribute('data-placement-id', placement.id);
        tab.innerHTML = `
            <i class="fas fa-${getPlacementIcon(placement.type)}"></i>
            ${displayType.substring(0, 15)}${displayType.length > 15 ? '...' : ''}
            ${placements.length > 1 ? `<span class="remove-tab" onclick="removePlacement(${placement.id})">&times;</span>` : ''}
        `;
        
        tab.addEventListener('click', (e) => {
            if (!e.target.classList.contains('remove-tab')) {
                showPlacement(placement.id);
            }
        });
        tabsContainer.appendChild(tab);
    });
}

function showPlacement(placementId) {
    document.querySelectorAll('.placement-section').forEach(section => {
        section.classList.remove('active');
    });
    
    const section = document.getElementById(`placement-section-${placementId}`);
    if (section) {
        section.classList.add('active');
    }
    
    document.querySelectorAll('.placement-tab').forEach(tab => {
        tab.classList.toggle('active', parseInt(tab.dataset.placementId) === placementId);
    });
    
    currentPlacementId = placementId;
}

function getPlacementIcon(type) {
    const icons = {
        'FRONT': 'tshirt',
        'BACK': 'tshirt',
        'SLEEVE': 'hat-cowboy',
        'CHEST': 'heart',
        'TV. NUMBERS': 'hashtag',
        'SHOULDER': 'user',
        'COLLAR': 'circle',
        'CUSTOM': 'star'
    };
    
    if (type.includes('CUSTOM:')) {
        return 'star';
    }
    return icons[type] || 'map-marker-alt';
}

// ========== FUNCIONES DE GESTI√ìN DE PLACEMENTS ==========
function updatePlacementType(placementId, type) {
    const placement = placements.find(p => p.id === placementId);
    if (placement) {
        const customInput = document.getElementById(`custom-placement-input-${placementId}`);
        
        if (type === 'CUSTOM') {
            if (customInput) customInput.style.display = 'block';
            if (!placement.type.startsWith('CUSTOM:')) {
                placement.type = 'CUSTOM:';
            }
        } else {
            if (customInput) customInput.style.display = 'none';
            placement.type = type;
            placement.name = type;
        }
        
        updatePlacementColorTitle(placementId);
        showStatus(`‚úÖ Tipo de placement cambiado a ${type}`);
    }
}

function updateCustomPlacement(placementId, customName) {
    const placement = placements.find(p => p.id === placementId);
    if (placement && customName.trim()) {
        placement.type = `CUSTOM: ${customName}`;
        placement.name = customName;
        updatePlacementColorTitle(placementId);
        showStatus(`‚úÖ Placement personalizado: ${customName}`);
    }
}

function updatePlacementInkType(placementId, inkType) {
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return;
    
    placement.inkType = inkType;
    
    const preset = Utils.getInkPreset(inkType);
    
    placement.temp = preset.temp;
    placement.time = preset.time;
    
    const tempField = document.getElementById(`temp-${placementId}`);
    const timeField = document.getElementById(`time-${placementId}`);
    
    if (tempField) {
        tempField.value = preset.temp;
    }
    
    if (timeField) {
        timeField.value = preset.time;
    }
    
    updatePlacementStations(placementId);
    showStatus(`‚úÖ Tinta: ${inkType} - Temp: ${preset.temp}, Tiempo: ${preset.time}`);
}

function duplicatePlacement(placementId) {
    const original = placements.find(p => p.id === placementId);
    if (!original) return;

    const newId = Date.now();
    const displayType = original.type.includes('CUSTOM:') 
        ? original.type.replace('CUSTOM: ', '')
        : original.type;

    const duplicate = JSON.parse(JSON.stringify(original));
    duplicate.id = newId;
    duplicate.name = displayType;

    if (!duplicate.specialties) duplicate.specialties = '';

    placements.push(duplicate);

    renderPlacementHTML(duplicate);
    updatePlacementsTabs();
    showPlacement(newId);

    updatePlacementColorTitle(newId);
    showStatus('‚úÖ Placement duplicado correctamente');

    return newId;
}

// ========== FUNCIONES PARA PAR√ÅMETROS EDITABLES ==========
function updatePlacementParam(placementId, param, value) {
    const placement = placements.find(p => p.id === placementId);
    if (placement) {
        placement[param] = value;
        updatePlacementStations(placementId);
    }
}

// ========== FUNCIONES PARA DIMENSIONES ==========
function extractDimensions(dimensionsText) {
    if (!dimensionsText) return { width: '15.34', height: '12' };
    
    const patterns = [
        /SIZE:\s*\(W\)\s*([\d\.]+)\s*["']?\s*X\s*\(H\)\s*([\d\.]+)/i,
        /([\d\.]+)\s*["']?\s*[xX√ó]\s*([\d\.]+)/,
        /W\s*:\s*([\d\.]+).*H\s*:\s*([\d\.]+)/i,
        /ANCHO\s*:\s*([\d\.]+).*ALTO\s*:\s*([\d\.]+)/i,
        /(\d+)\s*["']?\s*[xX]\s*(\d+)/
    ];
    
    for (const pattern of patterns) {
        const match = dimensionsText.match(pattern);
        if (match) {
            return {
                width: match[1],
                height: match[2]
            };
        }
    }
    
    return { width: '15.34', height: '12' };
}

function updatePlacementDimension(placementId, type, value) {
    const placement = placements.find(p => p.id === placementId);
    if (placement) {
        const wField = document.getElementById(`dimension-w-${placementId}`);
        const hField = document.getElementById(`dimension-h-${placementId}`);
        
        const width = type === 'width' ? value : (wField ? wField.value : '');
        const height = type === 'height' ? value : (hField ? hField.value : '');
        
        placement.width = width;
        placement.height = height;
        
        placement.dimensions = `SIZE: (W) ${width || '##'}" X (H) ${height || '##'}"`;
    }
}

// ========== FUNCIONES PARA COLORS DE PLACEMENTS ==========
function addPlacementColorItem(placementId, type) {
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return;
    
    let initialLetter = '';
    let initialVal = '';
    
    if (type === 'BLOCKER') {
        initialLetter = 'A';
        initialVal = 'BLOCKER CHT';
    } else if (type === 'WHITE_BASE') {
        initialLetter = 'B';
        initialVal = 'AQUAFLEX WHITE';
    } else if (type === 'METALLIC') {
        const colorItems = placement.colors.filter(c => c.type === 'COLOR' || c.type === 'METALLIC');
        initialLetter = String(colorItems.length + 1);
        initialVal = 'METALLIC GOLD';
    } else {
        const colorItems = placement.colors.filter(c => c.type === 'COLOR' || c.type === 'METALLIC');
        initialLetter = String(colorItems.length + 1);
    }
    
    const colorId = Date.now() + Math.random();
    placement.colors.push({
        id: colorId,
        type: type,
        screenLetter: initialLetter,
        val: initialVal
    });
    
    renderPlacementColors(placementId);
    updatePlacementStations(placementId);
    updatePlacementColorsPreview(placementId);
    checkForSpecialtiesInColors(placementId);
}

function renderPlacementColors(placementId) {
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return;
    
    const container = document.getElementById(`placement-colors-container-${placementId}`);
    if (!container) return;
    
    if (placement.colors.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                <i class="fas fa-palette" style="font-size: 1.5rem; margin-bottom: 10px; display: block;"></i>
                <p>No hay colores agregados para este placement.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    
    placement.colors.forEach(color => {
        let badgeClass = 'badge-color';
        let label = 'COLOR';
        
        if (color.type === 'BLOCKER') {
            badgeClass = 'badge-blocker';
            label = 'BLOQUEADOR';
        } else if (color.type === 'WHITE_BASE') {
            badgeClass = 'badge-white';
            label = 'WHITE BASE';
        } else if (color.type === 'METALLIC') {
            badgeClass = 'badge-warning';
            label = 'MET√ÅLICO';
        }
        
        const div = document.createElement('div');
        div.className = 'color-item';
        div.innerHTML = `
            <span class="badge ${badgeClass}">${label}</span>
            <input type="text" 
                   style="width: 60px; text-align: center; font-weight: bold;" 
                   value="${color.screenLetter}" 
                   class="form-control placement-screen-letter"
                   data-color-id="${color.id}"
                   data-placement-id="${placementId}"
                   oninput="updatePlacementScreenLetter(${placementId}, ${color.id}, this.value)"
                   title="Letra/N√∫mero de Pantalla">
            <input type="text" 
                   class="form-control placement-ink-input"
                   data-color-id="${color.id}"
                   data-placement-id="${placementId}"
                   placeholder="Nombre de la tinta..." 
                   value="${color.val}"
                   oninput="updatePlacementColorValue(${placementId}, ${color.id}, this.value)">
            <div class="color-preview" 
                 id="placement-color-preview-${placementId}-${color.id}" 
                 title="Vista previa del color"></div>
            <button class="btn btn-danger btn-sm" onclick="removePlacementColorItem(${placementId}, ${color.id})">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(div);
        
        // ACTUALIZAR INMEDIATAMENTE el preview
        setTimeout(() => updatePlacementColorPreview(placementId, color.id), 0);
    });
}

function updatePlacementColorValue(placementId, colorId, value) {
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return;
    
    const color = placement.colors.find(c => c.id === colorId);
    if (color) {
        color.val = value;
        updatePlacementColorPreview(placementId, colorId);
        updatePlacementStations(placementId);
        updatePlacementColorsPreview(placementId);
        checkForSpecialtiesInColors(placementId);
    }
}

function updatePlacementScreenLetter(placementId, colorId, value) {
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return;
    
    const color = placement.colors.find(c => c.id === colorId);
    if (color) {
        color.screenLetter = value.toUpperCase();
        updatePlacementStations(placementId);
    }
}

function removePlacementColorItem(placementId, colorId) {
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return;
    
    placement.colors = placement.colors.filter(c => c.id !== colorId);
    renderPlacementColors(placementId);
    updatePlacementStations(placementId);
    updatePlacementColorsPreview(placementId);
    checkForSpecialtiesInColors(placementId);
}

function updatePlacementColorPreview(placementId, colorId) {
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return;
    
    const color = placement.colors.find(c => c.id === colorId);
    if (!color) return;
    
    const preview = document.getElementById(`placement-color-preview-${placementId}-${colorId}`);
    if (!preview) return;
    
    const colorName = color.val.toUpperCase().trim();
    let colorHex = Utils.getColorHex(color.val);
    
    if (!colorHex) {
        const hexMatch = colorName.match(/#([0-9A-F]{6})/i);
        if (hexMatch) {
            colorHex = `#${hexMatch[1]}`;
        }
    }
    
    if (colorHex) {
        preview.style.background = colorHex;
        preview.style.backgroundImage = 'none';
        preview.title = `${color.val} - ${colorHex}`;
    } else if (colorName) {
        // Generar color basado en hash
        let hash = 0;
        for (let i = 0; i < colorName.length; i++) {
            hash = colorName.charCodeAt(i) + ((hash << 5) - hash);
        }
        const randomColor = `hsl(${Math.abs(hash % 360)}, 70%, 60%)`;
        preview.style.background = randomColor;
        preview.title = colorName;
    } else {
        preview.style.background = 'var(--gray-dark)';
        preview.style.backgroundImage = 'linear-gradient(45deg, var(--gray-medium) 25%, transparent 25%, transparent 75%, var(--gray-medium) 75%, var(--gray-medium)), linear-gradient(45deg, var(--gray-medium) 25%, transparent 25%, transparent 75%, var(--gray-medium) 75%, var(--gray-medium))';
        preview.style.backgroundSize = '10px 10px';
        preview.style.backgroundPosition = '0 0, 5px 5px';
        preview.title = 'Color no especificado';
    }
}

// ========== DETECCI√ìN DE ESPECIALIDADES ==========
function checkForSpecialtiesInColors(placementId) {
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return;
    
    let specialties = [];
    
    placement.colors.forEach(color => {
        if (color.val) {
            const colorVal = color.val.toUpperCase();
            
            if (colorVal.includes('HD') || colorVal.includes('HIGH DENSITY')) {
                if (!specialties.includes('HIGH DENSITY')) {
                    specialties.push('HIGH DENSITY');
                }
            }
            
            if (isMetallicColor(colorVal)) {
                if (!specialties.includes('METALLIC')) {
                    specialties.push('METALLIC');
                }
            }
            
            if (colorVal.includes('FOIL')) {
                if (!specialties.includes('FOIL')) {
                    specialties.push('FOIL');
                }
            }
        }
    });
    
    const specialtiesField = document.getElementById(`specialties-${placementId}`);
    if (specialtiesField) {
        specialtiesField.value = specialties.join(', ');
        updatePlacementField(placementId, 'specialties', specialtiesField.value);
    }
    
    return specialties;
}

function isMetallicColor(colorName) {
    if (!colorName) return false;
    
    const upperColor = colorName.toUpperCase();
    
    if (upperColor.match(/(8[7-9][0-9]\s*C?)/i)) {
        return true;
    }
    
    const METALLIC_CODES = [
        "871C", "872C", "873C", "874C", "875C", "876C", "877C",
        "METALLIC", "GOLD", "SILVER", "BRONZE", "MET√ÅLICO", "METALIC"
    ];
    
    for (const metallicCode of METALLIC_CODES) {
        if (upperColor.includes(metallicCode)) {
            return true;
        }
    }
    
    return false;
}

function updatePlacementColorsPreview(placementId) {
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return;
    
    const container = document.getElementById(`placement-colors-preview-${placementId}`);
    if (!container) return;
    
    const uniqueColors = [];
    const seenColors = new Set();
    
    placement.colors.forEach(color => {
        if (color.type === 'COLOR' || color.type === 'METALLIC') {
            const colorVal = color.val.toUpperCase().trim();
            if (colorVal && !seenColors.has(colorVal)) {
                seenColors.add(colorVal);
                uniqueColors.push({
                    val: colorVal,
                    screenLetter: color.screenLetter
                });
            }
        }
    });
    
    if (uniqueColors.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    let html = '<div><strong>Leyenda de Colores:</strong></div><div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 10px;">';
    
    uniqueColors.forEach(color => {
        const colorHex = Utils.getColorHex(color.val) || '#cccccc';
        html += `
            <div class="color-legend-item" style="display: flex; align-items: center; margin-bottom: 5px;">
                <div class="color-legend-swatch" style="background-color: ${colorHex}; border: 1px solid #666; width: 15px; height: 15px; margin-right: 5px;"></div>
                <span style="font-size: 11px;">${color.screenLetter}: ${color.val}</span>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// ========== FUNCIONES DE SECUENCIA DE PLACEMENTS ==========
function updatePlacementStations(placementId, returnOnly = false) {
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return [];
    
    const preset = Utils.getInkPreset(placement.inkType || 'WATER');
    
    const stationsData = [];
    let stNum = 1;
    
    const meshColor = placement.meshColor || preset.color.mesh;
    const meshWhite = placement.meshWhite || preset.white.mesh1;
    const meshBlocker = placement.meshBlocker || preset.blocker.mesh1;
    const durometer = placement.durometer || preset.color.durometer;
    const strokes = placement.strokes || preset.color.strokes;
    const angle = placement.angle || preset.color.angle;
    const pressure = placement.pressure || preset.color.pressure;
    const speed = placement.speed || preset.color.speed;
    const additives = placement.additives || preset.color.additives;
    
    placement.colors.forEach((item, idx) => {
        let mesh, strokesVal, duro, ang, press, spd, add, screenLetter, screenTypeLabel;
        
        screenLetter = item.screenLetter || 'N/A';
        
        if (item.type === 'BLOCKER') {
            screenTypeLabel = preset.blocker.name;
            mesh = meshBlocker;
            strokesVal = strokes;
            duro = durometer;
            ang = angle;
            press = pressure;
            spd = speed;
            add = additives;
        } else if (item.type === 'WHITE_BASE') {
            screenTypeLabel = preset.white.name;
            mesh = meshWhite;
            strokesVal = strokes;
            duro = durometer;
            ang = angle;
            press = pressure;
            spd = speed;
            add = additives;
        } else if (item.type === 'METALLIC') {
            screenTypeLabel = item.val || '---';
            mesh = '110/64';
            strokesVal = '1';
            duro = '70';
            ang = '15';
            press = '40';
            spd = '35';
            add = 'Catalizador especial para met√°licos';
        } else {
            screenTypeLabel = item.val || '---';
            mesh = meshColor;
            strokesVal = strokes;
            duro = durometer;
            ang = angle;
            press = pressure;
            spd = speed;
            add = additives;
        }
        
        const screenCombined = (item.type === 'BLOCKER' || item.type === 'WHITE_BASE' || item.type === 'METALLIC') 
                       ? screenTypeLabel
                       : item.val || '---';
        
        stationsData.push({ 
            st: stNum++, 
            screenLetter: screenLetter,
            screenCombined: screenCombined,
            mesh: mesh, 
            ink: item.val || '---',
            strokes: strokesVal, 
            duro: duro,
            angle: ang,
            pressure: press,
            speed: spd,
            add: add 
        });
        
        if (idx < placement.colors.length - 1) {
            stationsData.push({ 
                st: stNum++, 
                screenLetter: '', 
                screenCombined: 'FLASH', 
                mesh: '-', 
                ink: '-', 
                strokes: '-', 
                duro: '-',
                angle: '-',
                pressure: '-',
                speed: '-',
                add: '' 
            });
            
            stationsData.push({ 
                st: stNum++, 
                screenLetter: '', 
                screenCombined: 'COOL', 
                mesh: '-', 
                ink: '-', 
                strokes: '-', 
                duro: '-',
                angle: '-',
                pressure: '-',
                speed: '-',
                add: '' 
            });
        }
    });
    
    if (returnOnly) return stationsData;
    
    renderPlacementStationsTable(placementId, stationsData);
}

function renderPlacementStationsTable(placementId, data) {
    const div = document.getElementById(`placement-sequence-table-${placementId}`);
    if (!div) return;
    
    if (data.length === 0) {
        div.innerHTML = '<p style="color:var(--text-secondary); font-style:italic; text-align:center; padding:15px; background:var(--gray-dark); border-radius:var(--radius);">Agrega colores para generar la secuencia de impresi√≥n.</p>';
        return;
    }
    
    let html = `<table class="sequence-table">
        <thead><tr>
            <th>Est</th>
            <th>Scr.</th>
            <th>Screen (Tinta/Proceso)</th>
            <th>Aditivos</th>
            <th>Malla</th>
            <th>Str</th>
            <th>Ang</th>
            <th>Pres</th>
            <th>Spd</th>
            <th>Duro</th>
        </tr></thead><tbody>`;
    
    data.forEach((row, idx) => {
        const isMetallic = row.screenCombined && (
            row.screenCombined.includes('METALLIC') || 
            row.screenCombined.includes('GOLD') || 
            row.screenCombined.includes('SILVER') ||
            row.screenCombined.match(/(8[7-9][0-9])\s*C?/i)
        );
        
        html += `<tr ${isMetallic ? 'style="background: linear-gradient(90deg, rgba(255,215,0,0.1) 0%, var(--bg-card) 100%);"' : ''}>
            <td><strong>${row.st}</strong></td>
            <td><b style="color: var(--primary);">${row.screenLetter}</b></td>
            <td>${row.screenCombined}</td>
            <td style="font-size:11px; color:var(--primary); font-weight:600;">${row.add}</td>
            <td>${row.mesh}</td>
            <td>${row.strokes}</td>
            <td>${row.angle}</td>
            <td>${row.pressure}</td>
            <td>${row.speed}</td>
            <td>${row.duro}</td>
        </tr>`;
    });
    html += '</tbody></table>';
    div.innerHTML = html;
}

// ========== FUNCIONES DE IM√ÅGENES ==========
function openImagePickerForPlacement(placementId) {
    currentPlacementId = placementId;
    document.getElementById('placementImageInput').click();
}

document.getElementById('placementImageInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const placementId = currentPlacementId;
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return;
    
    if (!file.type.match('image.*')) {
        showStatus('‚ùå Por favor, selecciona un archivo de imagen v√°lido', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(ev) {
        const img = document.getElementById(`placement-image-preview-${placementId}`);
        const imageActions = document.getElementById(`placement-image-actions-${placementId}`);
        
        if (img) {
            img.src = ev.target.result;
            img.style.display = 'block';
        }
        
        if (imageActions) {
            imageActions.style.display = 'flex';
        }
        
        placement.imageData = ev.target.result;
        showStatus(`‚úÖ Imagen cargada para ${placement.type}`);
    };
    reader.readAsDataURL(file);
    
    e.target.value = '';
});

function removePlacementImage(placementId) {
    const placement = placements.find(p => p.id === placementId);
    if (!placement) return;
    
    const img = document.getElementById(`placement-image-preview-${placementId}`);
    const imageActions = document.getElementById(`placement-image-actions-${placementId}`);
    
    if (img) {
        img.src = '';
        img.style.display = 'none';
    }
    
    if (imageActions) {
        imageActions.style.display = 'none';
    }
    
    placement.imageData = null;
    showStatus('üóëÔ∏è Imagen eliminada del placement');
}

// ========== FUNCIONES DE ACTUALIZACI√ìN ==========
function updatePlacementField(placementId, field, value) {
    const placement = placements.find(p => p.id === placementId);
    if (placement) {
        if (field === 'specialties') {
            let specialties = value.toUpperCase();
            
            if (specialties.includes('HD') && !specialties.includes('HIGH DENSITY')) {
                specialties = specialties.replace(/\bHD\b/g, 'HIGH DENSITY');
            }
            
            placement[field] = specialties;
        } else {
            placement[field] = value;
        }
    }
}

// ========== FUNCIONES DE DASHBOARD ==========
function updateDashboard() {
    try {
        const specs = Object.keys(localStorage).filter(k => k.startsWith('spec_'));
        const total = specs.length;
        document.getElementById('total-specs').textContent = total;
        
        let lastSpec = null;
        let lastSpecDate = null;
        
        specs.forEach(key => {
            try {
                const data = JSON.parse(localStorage.getItem(key));
                const specDate = new Date(data.savedAt || 0);
                
                if (!lastSpecDate || specDate > lastSpecDate) {
                    lastSpecDate = specDate;
                    lastSpec = data;
                }
            } catch(e) {
                console.warn('Error al parsear spec:', key, e);
            }
        });
        
        if (lastSpec) {
            document.getElementById('today-specs').innerHTML = `
                <div style="font-size:0.9rem; color:var(--text-secondary);">√öltima Spec:</div>
                <div style="font-size:1.2rem; font-weight:bold; color:var(--primary);">${lastSpec.style || 'Sin nombre'}</div>
                <div style="font-size:0.8rem; color:var(--text-secondary);">${lastSpecDate.toLocaleDateString('es-ES')}</div>
            `;
        }
        
        let activeCount = 0;
        specs.forEach(key => {
            try {
                const data = JSON.parse(localStorage.getItem(key));
                if (data.placements && data.placements.length > 0) {
                    activeCount++;
                }
            } catch(e) {}
        });
        
        document.getElementById('active-projects').textContent = activeCount;
        
        const totalPlacements = specs.reduce((total, key) => {
            try {
                const data = JSON.parse(localStorage.getItem(key));
                return total + (data.placements?.length || 0);
            } catch(e) {
                return total;
            }
        }, 0);
        
        document.getElementById('completion-rate').innerHTML = `
            <div style="font-size:0.9rem; color:var(--text-secondary);">Placements totales:</div>
            <div style="font-size:1.5rem; font-weight:bold; color:var(--primary);">${totalPlacements}</div>
        `;
        
    } catch (error) {
        console.error('Error en updateDashboard:', error);
    }
}

// ========== FUNCIONES DE STORAGE ==========
function loadSavedSpecsList() {
    const list = document.getElementById('saved-specs-list');
    const specs = Object.keys(localStorage).filter(key => key.startsWith('spec_'));
    
    if (specs.length === 0) {
        list.innerHTML = `
            <p style="text-align: center; color: var(--text-secondary); padding: 30px;">
                <i class="fas fa-database" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                No hay specs guardadas. Crea una nueva spec para verla aqu√≠.
            </p>
        `;
        return;
    }
    
    list.innerHTML = '';
    specs.forEach(key => {
        try {
            const data = JSON.parse(localStorage.getItem(key));
            const div = document.createElement('div');
            div.style.cssText = "padding:15px; border-bottom:1px solid var(--border-dark); display:flex; justify-content:space-between; align-items:center; transition: var(--transition);";
            div.innerHTML = `
                <div style="flex: 1;">
                    <div style="font-weight: 700; color: var(--primary);">${data.style || 'N/A'}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Cliente: ${data.customer || 'N/A'} | Colorway: ${data.colorway || 'N/A'}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Guardado: ${new Date(data.savedAt).toLocaleDateString('es-ES')}</div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary btn-sm" onclick='loadSpecData(${JSON.stringify(data)})'><i class="fas fa-edit"></i> Cargar</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteSpec('${key}')"><i class="fas fa-trash"></i></button>
                </div>
            `;
            list.appendChild(div);
        } catch (e) {
            console.error('Error al parsear spec guardada:', key, e);
            localStorage.removeItem(key);
        }
    });
}

function loadSpecData(data) {
    document.getElementById('customer').value = data.customer || '';
    document.getElementById('style').value = data.style || '';
    document.getElementById('folder-num').value = data.folder || ''; 
    document.getElementById('colorway').value = data.colorway || '';
    document.getElementById('season').value = data.season || '';
    document.getElementById('pattern').value = data.pattern || '';
    document.getElementById('po').value = data.po || '';
    document.getElementById('sample-type').value = data.sampleType || '';
    document.getElementById('name-team').value = data.nameTeam || '';
    document.getElementById('gender').value = data.gender || '';
    document.getElementById('designer').value = data.designer || '';
    
    document.getElementById('placements-container').innerHTML = '';
    placements = [];
    
    if (data.placements && Array.isArray(data.placements)) {
        data.placements.forEach((placementData, index) => {
            const placementId = index === 0 ? 1 : Date.now() + index;
            const placement = {
                ...placementData,
                id: placementId
            };
            
            if (index === 0) {
                placements = [placement];
            } else {
                placements.push(placement);
            }
            
            renderPlacementHTML(placement);
            
            if (placement.imageData) {
                const img = document.getElementById(`placement-image-preview-${placementId}`);
                const imageActions = document.getElementById(`placement-image-actions-${placementId}`);
                
                if (img && imageActions) {
                    img.src = placement.imageData;
                    img.style.display = 'block';
                    imageActions.style.display = 'flex';
                }
            }
            
            renderPlacementColors(placementId);
            updatePlacementStations(placementId);
            updatePlacementColorsPreview(placementId);
            updatePlacementColorTitle(placementId);
        });
    } else {
        initializePlacements();
    }
    
    updatePlacementsTabs();
    showPlacement(1);
    updateClientLogo();
    
    showTab('spec-creator');
    showStatus('üìÇ Spec cargada correctamente');
}

function deleteSpec(key) {
    if (confirm('¬øEst√°s seguro de que quieres eliminar esta spec?')) {
        localStorage.removeItem(key);
        loadSavedSpecsList();
        updateDashboard();
        showStatus('üóëÔ∏è Spec eliminada', 'success');
    }
}

function clearAllSpecs() {
    if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar TODAS las specs guardadas?')) {
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('spec_')) {
                localStorage.removeItem(key);
            }
        });
        loadSavedSpecsList();
        updateDashboard();
        showStatus('üóëÔ∏è Todas las specs han sido eliminadas', 'success');
    }
}

// ========== FUNCIONES DE GUARDADO ==========
function saveCurrentSpec() {
    try {
        const data = collectData();
        const style = data.style || 'SinEstilo_' + Date.now();
        const storageKey = `spec_${style}_${Date.now()}`;
        
        placements.forEach(placement => {
            const specialtiesField = document.getElementById(`specialties-${placement.id}`);
            if (specialtiesField) {
                placement.specialties = specialtiesField.value;
            }
            
            const instructionsField = document.getElementById(`special-instructions-${placement.id}`);
            if (instructionsField) {
                placement.specialInstructions = instructionsField.value;
            }
        });
        
        data.savedAt = new Date().toISOString();
        data.lastModified = new Date().toISOString();
        
        localStorage.setItem(storageKey, JSON.stringify(data));
        
        updateDashboard();
        loadSavedSpecsList();
        
        showStatus('‚úÖ Spec guardada correctamente', 'success');
        
    } catch (error) {
        console.error('Error al guardar:', error);
        showStatus('‚ùå Error al guardar: ' + error.message, 'error');
    }
}

function collectData() {
    const generalData = {
        customer: document.getElementById('customer').value,
        style: document.getElementById('style').value,
        folder: document.getElementById('folder-num').value,
        colorway: document.getElementById('colorway').value,
        season: document.getElementById('season').value,
        pattern: document.getElementById('pattern').value,
        po: document.getElementById('po').value,
        sampleType: document.getElementById('sample-type').value,
        nameTeam: document.getElementById('name-team').value,
        gender: document.getElementById('gender').value,
        designer: document.getElementById('designer').value,
        savedAt: new Date().toISOString()
    };
    
    const placementsData = placements.map(placement => ({
        id: placement.id,
        type: placement.type,
        name: placement.name,
        imageData: placement.imageData,
        colors: placement.colors.map(c => ({
            id: c.id,
            type: c.type,
            val: c.val,
            screenLetter: c.screenLetter
        })),
        placementDetails: placement.placementDetails,
        dimensions: placement.dimensions,
        width: placement.width,
        height: placement.height,
        temp: placement.temp,
        time: placement.time,
        specialties: placement.specialties,
        specialInstructions: placement.specialInstructions,
        inkType: placement.inkType,
        placementSelect: placement.placementSelect,
        meshColor: placement.meshColor,
        meshWhite: placement.meshWhite,
        meshBlocker: placement.meshBlocker,
        durometer: placement.durometer,
        strokes: placement.strokes,
        angle: placement.angle,
        pressure: placement.pressure,
        speed: placement.speed,
        additives: placement.additives
    }));
    
    return {
        ...generalData,
        placements: placementsData
    };
}

// ========== FUNCIONES DE LIMPIEZA ==========
function clearForm() {
    if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres limpiar todo el formulario?')) {
        document.querySelectorAll('input:not(#folder-num), textarea, select').forEach(i => {
            if (i.type !== 'button' && i.type !== 'submit') {
                i.value = '';
            }
        });
        document.getElementById('designer').value = '';
        
        placements = [];
        document.getElementById('placements-container').innerHTML = '';
        document.getElementById('placements-tabs').innerHTML = '';
        
        initializePlacements();
        
        const logoElement = document.getElementById('logoCliente');
        if (logoElement) {
            logoElement.style.display = 'none';
        }
        
        showStatus('üßπ Formulario limpiado correctamente');
    }
}

// ========== FUNCIONES DE EXPORTACI√ìN ==========
function hexToRgb(hex) {
    if (!hex) return [0, 0, 0];
    hex = hex.replace('#', '');
    
    if (hex.length === 3) {
        hex = hex.split('').map(char => char + char).join('');
    }
    
    const r = parseInt(hex.substring(0, 2), 16);
    const g = parseInt(hex.substring(2, 4), 16);
    const b = parseInt(hex.substring(4, 6), 16);
    
    return [r, g, b];
}

async function exportPDF() {
    try {
        if (typeof window.jspdf === 'undefined') {
            showStatus('‚ùå jsPDF no est√° cargado', 'error');
            return;
        }

        showStatus('üìÑ Generando PDF...', 'warning');
        
        const pdfBlob = await generatePDFBlob();
        
        const style = document.getElementById('style').value || 'SinEstilo';
        const folderNum = document.getElementById('folder-num').value || '00000';
        const fileName = `TegraSpec_${style}_${folderNum}.pdf`;
        
        const url = URL.createObjectURL(pdfBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showStatus('‚úÖ PDF generado correctamente', 'success');
        
    } catch (error) {
        console.error('Error al exportar PDF:', error);
        showStatus('‚ùå Error al generar PDF: ' + error.message, 'error');
    }
}

async function generatePDFBlob() {
    return new Promise(async (resolve, reject) => {
        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'letter');
            const pageW = pdf.internal.pageSize.getWidth(); // 215.9 mm (8.5")
            const pageH = pdf.internal.pageSize.getHeight(); // 279.4 mm (11")
            
            const margin = 8; // REDUCIDO para usar m√°s espacio
            const contentWidth = pageW - (2 * margin); // ~200mm
            let y = margin;
            
            const primaryColor = [255, 82, 82];
            const accentColor = [255, 138, 128];
            const grayLight = [240, 240, 240];
            const grayDark = [100, 100, 100];
            
            const checkPageBreak = (neededHeight) => {
                if (y + neededHeight > pageH - margin) {
                    pdf.addPage();
                    y = margin;
                    return true;
                }
                return false;
            };
            
            const addText = (str, x, yPos, size = 10, bold = false, color = [0, 0, 0], align = 'left', maxWidth = null) => {
                pdf.setTextColor(...color);
                pdf.setFontSize(size);
                pdf.setFont('helvetica', bold ? 'bold' : 'normal');
                const textStr = String(str || '');
                
                if (maxWidth) {
                    const splitLines = pdf.splitTextToSize(textStr, maxWidth);
                    pdf.text(splitLines, x, yPos, { align: align });
                    return splitLines.length * (size * 0.35);
                } else {
                    pdf.text(textStr, x, yPos, { align: align });
                    return size * 0.35;
                }
            };
            
            const drawRect = (x, yPos, width, height, fillColor = null, strokeColor = [0, 0, 0], lineWidth = 0.2) => {
                if (fillColor) {
                    pdf.setFillColor(...fillColor);
                    pdf.rect(x, yPos, width, height, 'F');
                }
                pdf.setDrawColor(...strokeColor);
                pdf.setLineWidth(lineWidth);
                pdf.rect(x, yPos, width, height);
                return height;
            };
            
            // ===== CABECERA =====
            pdf.setFillColor(...primaryColor);
            const headerHeight = 20;
            drawRect(0, 0, pageW, headerHeight, primaryColor);
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(20);
            pdf.setFont("helvetica", "bold");
            pdf.text("TEGRA", margin, 14);
            
            pdf.setFontSize(11);
            pdf.text("TECHNICAL SPEC MANAGER", margin, 20);
            
            const folderNum = document.getElementById('folder-num').value || '#####';
            pdf.setFontSize(8);
            pdf.text('FOLDER', pageW - margin, 14, { align: 'right' });
            pdf.setFontSize(16);
            pdf.text(`#${folderNum}`, pageW - margin, 20, { align: 'right' });
            
            y = 30;
            
            // ===== INFORMACI√ìN GENERAL =====
            checkPageBreak(45);
            const infoHeight = 45;
            drawRect(margin, y, contentWidth, infoHeight, [250, 250, 250], grayLight);
            addText('INFORMACI√ìN GENERAL', margin + 5, y + 8, 12, true, primaryColor);
            
            const generalData = [
                { label: 'CLIENTE:', value: document.getElementById('customer').value || '---' },
                { label: 'STYLE:', value: document.getElementById('style').value || '---' },
                { label: 'COLORWAY:', value: document.getElementById('colorway').value || '---' },
                { label: 'SEASON:', value: document.getElementById('season').value || '---' },
                { label: 'PATTERN #:', value: document.getElementById('pattern').value || '---' },
                { label: 'P.O. #:', value: document.getElementById('po').value || '---' },
                { label: 'SAMPLE TYPE:', value: document.getElementById('sample-type').value || '---' },
                { label: 'TEAM:', value: document.getElementById('name-team').value || '---' },
                { label: 'GENDER:', value: document.getElementById('gender').value || '---' },
                { label: 'DESIGNER:', value: document.getElementById('designer').value || '---' }
            ];
            
            let infoY = y + 15;
            generalData.forEach((item, i) => {
                const xPos = i % 2 === 0 ? margin + 10 : margin + 110;
                addText(item.label, xPos, infoY, 9, true);
                addText(item.value, xPos + 25, infoY, 9, false);
                if (i % 2 !== 0) infoY += 6;
            });
            
            y += infoHeight + 10;
            
            // ===== PLACEMENTS =====
            for (let pIndex = 0; pIndex < placements.length; pIndex++) {
                const placement = placements[pIndex];
                
                if (!placement) continue;
                
                if (pIndex > 0) {
                    pdf.addPage();
                    y = margin;
                }
                
                const displayType = placement.type && placement.type.includes('CUSTOM:') 
                    ? placement.type.replace('CUSTOM: ', '')
                    : (placement.type || 'N/A');
                
                // Header del placement
                checkPageBreak(15);
                pdf.setFillColor(...primaryColor);
                drawRect(margin, y, contentWidth, 10, primaryColor, primaryColor, 0);
                addText(`PLACEMENT: ${displayType}`, margin + 5, y + 6, 11, true, [255, 255, 255]);
                y += 15;
                
                // Imagen del placement
                if (placement.imageData && placement.imageData.startsWith('data:')) {
                    try {
                        checkPageBreak(75);
                        
                        const imgHeight = 70;
                        const imgWidth = 90;
                        
                        drawRect(margin + 5, y, imgWidth, imgHeight, [245, 245, 245], grayLight);
                        
                        pdf.addImage(placement.imageData, 'JPEG', margin + 7, y + 2, imgWidth - 4, imgHeight - 4);
                        
                        const detailsX = margin + imgWidth + 15;
                        const detailsWidth = contentWidth - imgWidth - 10;
                        
                        drawRect(detailsX, y, detailsWidth, imgHeight, [250, 250, 250], grayLight);
                        
                        let detailY = y + 10;
                        addText('DETALLES DEL PLACEMENT', detailsX + 5, detailY, 10, true, primaryColor);
                        detailY += 8;
                        
                        const details = [
                            `Tipo de tinta: ${placement.inkType || '---'}`,
                            `Dimensiones: ${placement.width || '##'}" X ${placement.height || '##'}"`,
                            `Ubicaci√≥n: ${displayType || '---'}`,
                            `Placement: ${placement.placementDetails || '---'}`,
                            `Especialidades: ${placement.specialties || '---'}`
                        ];
                        
                        details.forEach(detail => {
                            addText(detail, detailsX + 5, detailY, 8);
                            detailY += 5;
                        });
                        
                        y += imgHeight + 12;
                    } catch (e) {
                        console.warn('No se pudo agregar imagen al PDF:', e);
                        y += 10;
                    }
                } else {
                    y += 5;
                }
                
                // Colores del placement
                const uniqueColors = [];
                const seenColors = new Set();
                
                if (placement.colors && Array.isArray(placement.colors)) {
                    placement.colors.forEach(color => {
                        if (color && (color.type === 'COLOR' || color.type === 'METALLIC') && color.val) {
                            const colorVal = color.val.toUpperCase().trim();
                            if (colorVal && !seenColors.has(colorVal)) {
                                seenColors.add(colorVal);
                                uniqueColors.push({
                                    val: colorVal,
                                    screenLetter: color.screenLetter || ''
                                });
                            }
                        }
                    });
                    
                    if (uniqueColors.length > 0) {
                        checkPageBreak(40);
                        
                        const colorsHeight = 40;
                        drawRect(margin, y, contentWidth, colorsHeight, [250, 250, 250], grayLight);
                        addText('COLORES Y TINTAS', margin + 5, y + 8, 11, true, primaryColor);
                        
                        let colorY = y + 15;
                        let colorX = margin + 10;
                        let colorsInRow = 0;
                        
                        uniqueColors.forEach((color) => {
                            const colorHex = Utils.getColorHex(color.val) || '#cccccc';
                            const rgb = hexToRgb(colorHex);
                            
                            pdf.setFillColor(rgb[0], rgb[1], rgb[2]);
                            pdf.rect(colorX, colorY, 8, 8, 'F');
                            pdf.setDrawColor(0, 0, 0);
                            pdf.setLineWidth(0.1);
                            pdf.rect(colorX, colorY, 8, 8);
                            
                            addText(`${color.screenLetter}: ${color.val}`, colorX + 10, colorY + 5, 7);
                            
                            colorX += 70;
                            colorsInRow++;
                            
                            if (colorsInRow >= 3 || colorX > pageW - 70) {
                                colorX = margin + 10;
                                colorY += 15;
                                colorsInRow = 0;
                            }
                        });
                        
                        y += colorsHeight + 10;
                    }
                }
                
                // SECUENCIA DE IMPRESI√ìN
                let stationsData = [];
                try {
                    stationsData = updatePlacementStations(placement.id, true) || [];
                } catch (e) {
                    console.warn('Error obteniendo stations data:', e);
                }
                
                if (stationsData.length > 0) {
                    checkPageBreak(150);
                    
                    addText(`SECUENCIA DE IMPRESI√ìN - ${displayType}`, margin, y, 12, true, primaryColor);
                    y += 8;
                    
                    // Header de la tabla - ANCHOS AJUSTADOS
                    pdf.setFillColor(...primaryColor);
                    const headerHeight = 6; // REDUCIDO
                    drawRect(margin, y, contentWidth, headerHeight, primaryColor, primaryColor, 0);
                    
                    const pdfHeaders = ['Est', 'Scr.', 'Screen', 'Aditivos', 'Malla', 'Str', 'Ang', 'Pres', 'Spd', 'Duro'];
                    const pdfColW = [8, 8, 35, 45, 12, 8, 8, 8, 8, 8]; // TOTAL ~148mm
                    let x = margin;
                    
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFontSize(7); // REDUCIDO
                    pdf.setFont('helvetica', 'bold');
                    
                    pdfHeaders.forEach((h, i) => {
                        pdf.text(h, x + 1, y + 4);
                        x += pdfColW[i];
                    });
                    
                    y += headerHeight + 1;
                    
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFont('helvetica', 'normal');
                    
                    let rowY = y;
                    pdf.setFontSize(6); // REDUCIDO para que quepa
                    
                    stationsData.forEach((row, idx) => {
                        if (rowY > pageH - 20) {
                            pdf.addPage();
                            rowY = margin;
                            pdf.setFontSize(6);
                        }
                        
                        if (idx % 2 === 0 && row.screenCombined !== 'FLASH' && row.screenCombined !== 'COOL') {
                            pdf.setFillColor(248, 248, 248);
                            pdf.rect(margin, rowY - 2, contentWidth, 4, 'F');
                        }
                        
                        x = margin;
                        const data = [
                            row.st || '', 
                            row.screenLetter || '', 
                            row.screenCombined || '', 
                            row.add || '', 
                            row.mesh || '', 
                            row.strokes || '',
                            row.angle || '',
                            row.pressure || '',
                            row.speed || '',
                            row.duro || ''
                        ];
                        
                        data.forEach((d, i) => {
                            let safeText = String(d || '');
                            
                            if (i === 3 && safeText.length > 25) {
                                safeText = safeText.substring(0, 22) + '...';
                            }
                            
                            if (i === 1) {
                                pdf.setFont('helvetica', 'bold');
                                pdf.setTextColor(...primaryColor);
                            }
                            
                            if (i === 3) {
                                pdf.setTextColor(...accentColor);
                            }
                            
                            pdf.text(safeText, x + 1, rowY);
                            x += pdfColW[i];
                            
                            if (i === 1) pdf.setFont('helvetica', 'normal');
                            if (i === 3) {
                                pdf.setTextColor(0, 0, 0);
                            }
                        });
                        
                        rowY += 4; // ESPACIO REDUCIDO
                    });
                    
                    y = rowY + 8;
                    pdf.setFontSize(10); // Restaurar tama√±o
                }
                
                // CONDICIONES DE CURADO
                checkPageBreak(25);
                
                const cureHeight = 25;
                pdf.setFillColor(245, 245, 245);
                drawRect(margin, y, contentWidth, cureHeight, [245, 245, 245], grayLight);
                
                addText('CONDICIONES DE CURADO', margin + 5, y + 8, 10, true, primaryColor);
                
                const temp = placement.temp || '320 ¬∞F';
                const time = placement.time || '1:40 min';
                
                addText(`Temp: ${temp}`, margin + 10, y + 16, 9, true);
                addText(`Tiempo: ${time}`, margin + 50, y + 16, 9, true);
                addText(`Tinta: ${placement.inkType || 'WATER'}`, margin + 100, y + 16, 9, true);
                
                y += cureHeight + 10;
                
                // INSTRUCCIONES ESPECIALES
                if (placement.specialInstructions && placement.specialInstructions.trim()) {
                    checkPageBreak(35);
                    
                    const instructionsHeight = 35;
                    pdf.setFillColor(255, 253, 231);
                    drawRect(margin, y, contentWidth, instructionsHeight, [255, 253, 231], [255, 193, 7]);
                    
                    addText('INSTRUCCIONES ESPECIALES:', margin + 5, y + 8, 9, true, [255, 193, 7]);
                    
                    const instructions = placement.specialInstructions;
                    const splitText = pdf.splitTextToSize(instructions, contentWidth - 10);
                    
                    pdf.setFontSize(8);
                    pdf.setTextColor(66, 66, 66);
                    pdf.text(splitText, margin + 5, y + 15);
                    
                    y += instructionsHeight + 10;
                }
            }
            
            // FOOTER FINAL
            const footerY = pageH - 15;
            
            pdf.setFontSize(8);
            pdf.setTextColor(150, 150, 150);
            
            const dateStr = new Date().toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            addText(`Generado: ${dateStr}`, margin, footerY);
            
            if (placements.length > 0) {
                addText(`Total de placements: ${placements.length}`, pageW / 2, footerY, 8, false, [150, 150, 150], 'center');
            }
            
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(...primaryColor);
            pdf.text('TEGRA Spec Manager', pageW - margin, footerY, 8, true, primaryColor, 'right');
            
            const pdfBlob = pdf.output('blob');
            resolve(pdfBlob);
            
        } catch (error) {
            console.error('Error al generar PDF:', error);
            reject(error);
        }
    });
}

function exportToExcel() {
    try {
        if (typeof XLSX === 'undefined') {
            showStatus('‚ùå Error: Biblioteca Excel no cargada', 'error');
            return;
        }
        
        const data = {
            designer: document.getElementById('designer').value || '',
            customer: document.getElementById('customer').value || '',
            season: document.getElementById('season').value || '',
            folder: document.getElementById('folder-num').value || '',
            nameTeam: document.getElementById('name-team').value || '',
            colorway: document.getElementById('colorway').value || '',
            style: document.getElementById('style').value || ''
        };
        
        const wb = XLSX.utils.book_new();
        
        const headers = [
            'Area', 'Designer', 'Customer', 'Division', 'SEASON',
            '', '#Folder/SPEC', '', '', '', '', '', '', '', '', '', '', '', '',
            'TEAM', '', '', 'COLORWAY', '', 'PLACEMENTS', '', 'SPEC #', '#SCREEEN', 
            'NO. COLORES', 'Stations', 'setup', 'size', 'W', 'H', 'TYPE OF ART', 'INK TYPE'
        ];
        
        const rows = [];
        
        if (placements && placements.length > 0) {
            placements.forEach((placement, index) => {
                const placementType = placement.type.includes('CUSTOM:') 
                    ? placement.type.replace('CUSTOM: ', '').toLowerCase()
                    : placement.type.toLowerCase();
                
                const screenCount = placement.colors ? placement.colors.length : 0;
                const colorCount = screenCount;
                const stationCount = colorCount > 0 ? (colorCount * 3 - 2) : 0;
                const artType = 'Vector';
                
                let inkType = 'WB MAGNA';
                if (placement.inkType === 'WATER') inkType = 'WB MAGNA';
                if (placement.inkType === 'PLASTISOL') inkType = 'PLASTISOL';
                if (placement.inkType === 'SILICONE') inkType = 'SILICONE';
                
                const width = placement.width || extractDimensions(placement.dimensions).width;
                const height = placement.height || extractDimensions(placement.dimensions).height;
                
                const row = [
                    'Development',                            
                    data.designer,                          
                    data.customer,                          
                    'NFL / jersey',                         
                    data.season,                            
                    '',                                     
                    data.folder,                            
                    '', '', '', '', '', '', '', '', '', '', '', '', '', 
                    data.nameTeam,                          
                    '', '',                                 
                    data.colorway,                          
                    '',                                     
                    placementType,                          
                    '',                                     
                    `SPEC ${index + 1}`,                   
                    screenCount,                            
                    colorCount,                             
                    stationCount,                           
                    1,                                      
                    'L',                                    
                    `${width}"`,                    
                    `${height}"`,                   
                    artType,                                
                    inkType                                 
                ];
                
                rows.push(row);
            });
        } else {
            const defaultRow = [
                'Development',      
                data.designer,      
                data.customer,      
                'NFL / jersey',     
                data.season,        
                '',                 
                data.folder,        
                '', '', '', '', '', '', '', '', '', '', '', '', '', 
                data.nameTeam,      
                '', '',             
                data.colorway,      
                '',                 
                'front',            
                '',                 
                'SPEC 1',           
                0,                  
                0,                  
                0,                  
                1,                  
                'L',                
                '15.34"',           
                '12"',              
                'Vector',           
                'WB MAGNA'          
            ];
            
            rows.push(defaultRow);
        }
        
        const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
        
        const colWidths = [];
        for (let i = 0; i < headers.length; i++) {
            if (i === 0) colWidths.push({ wch: 12 });
            else if (i === 1) colWidths.push({ wch: 12 });
            else if (i === 2) colWidths.push({ wch: 15 });
            else if (i === 3) colWidths.push({ wch: 15 });
            else if (i === 4) colWidths.push({ wch: 8 });
            else if (i === 6) colWidths.push({ wch: 12 });
            else if (i === 20) colWidths.push({ wch: 25 });
            else if (i === 23) colWidths.push({ wch: 15 });
            else if (i === 25) colWidths.push({ wch: 12 });
            else if (i === 27) colWidths.push({ wch: 8 });
            else if (i === 28) colWidths.push({ wch: 10 });
            else if (i === 29) colWidths.push({ wch: 12 });
            else if (i === 30) colWidths.push({ wch: 10 });
            else if (i === 34) colWidths.push({ wch: 10 });
            else if (i === 35) colWidths.push({ wch: 12 });
            else colWidths.push({ wch: 3 });
        }
        ws['!cols'] = colWidths;
        
        const headerRange = XLSX.utils.decode_range(ws['!ref']);
        for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
            const cellAddress = XLSX.utils.encode_cell({ r: 0, c: C });
            if (!ws[cellAddress]) continue;
            
            if (headers[C] && headers[C] !== '') {
                ws[cellAddress].s = {
                    font: { bold: true, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "4472C4" } },
                    alignment: { horizontal: "center", vertical: "center" }
                };
            }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, 'Hoja1');
        
        const fileName = `Calculadora_${data.style || 'Spec'}_${data.folder || '00000'}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        showStatus('üìä Spec Excel generada correctamente', 'success');
        
    } catch (error) {
        console.error('Error al exportar Excel:', error);
        showStatus('‚ùå Error al generar Spec Excel: ' + error.message, 'error');
    }
}

// ========== FUNCIONES PARA LOG DE ERRORES ==========
function loadErrorLog() {
    const container = document.getElementById('error-log-content');
    if (!container) return;
    
    let errors = [];
    try {
        if (window.errorHandler && window.errorHandler.getErrors) {
            errors = window.errorHandler.getErrors();
        }
    } catch (e) {
        console.warn('No se pudo obtener errores:', e);
    }
    
    if (errors.length === 0) {
        container.innerHTML = `
            <p style="text-align: center; color: var(--text-secondary); padding: 30px;">
                <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px; display: block; color: var(--success);"></i>
                No hay errores registrados en el log.
            </p>
        `;
        return;
    }
    
    let html = `
        <div style="margin-bottom: 20px;">
            <p>Total de errores: <strong>${errors.length}</strong></p>
        </div>
    `;
    
    errors.forEach((error, index) => {
        html += `
            <div class="card" style="margin-bottom: 15px; border-left: 4px solid var(--error);">
                <div class="card-body">
                    <div style="margin-bottom: 10px;">
                        <div>
                            <strong style="color: var(--error);">${error.context || 'Error'}</strong>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                ${new Date(error.timestamp).toLocaleString('es-ES')}
                            </div>
                        </div>
                    </div>
                    <div style="background: var(--gray-dark); padding: 10px; border-radius: var(--radius); margin-bottom: 10px;">
                        <code style="color: var(--text-primary); font-size: 0.85rem;">
                            ${error.error?.message || 'Sin mensaje'}
                        </code>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ========== FUNCIONES DE INICIALIZACI√ìN ==========
document.addEventListener('DOMContentLoaded', () => {
    try {
        updateDateTime();
        updateDashboard();
        loadSavedSpecsList();
        setupPasteHandler();
        loadThemePreference();
        
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        
        setInterval(updateDateTime, 60000);
        
        setTimeout(() => {
            if (placements.length === 0) {
                initializePlacements();
            }
        }, 100);
        
    } catch (error) {
        console.error('Error en inicializaci√≥n:', error);
        showStatus('‚ùå Error al iniciar la aplicaci√≥n', 'error');
    }
});

// ========== EXPORTAR FUNCIONES AL CONTEXTO GLOBAL ==========
window.showTab = showTab;
window.loadSavedSpecsList = loadSavedSpecsList;
window.clearAllSpecs = clearAllSpecs;
window.addNewPlacement = addNewPlacement;
window.saveCurrentSpec = saveCurrentSpec;
window.clearForm = clearForm;
window.exportToExcel = exportToExcel;
window.exportPDF = exportPDF;
window.removePlacement = function(placementId) {
    if (placements.length <= 1) {
        showStatus('‚ùå No puedes eliminar el √∫ltimo placement', 'error');
        return;
    }
    
    if (confirm('¬øEst√°s seguro de que quieres eliminar este placement?')) {
        placements = placements.filter(p => p.id !== placementId);
        
        const section = document.getElementById(`placement-section-${placementId}`);
        if (section) section.remove();
        
        updatePlacementsTabs();
        
        if (placements.length > 0) {
            showPlacement(placements[0].id);
        }
        
        showStatus('üóëÔ∏è Placement eliminado');
    }
};

window.duplicatePlacement = duplicatePlacement;
window.updatePlacementType = updatePlacementType;
window.updatePlacementInkType = updatePlacementInkType;
window.openImagePickerForPlacement = openImagePickerForPlacement;
window.removePlacementImage = removePlacementImage;
window.addPlacementColorItem = addPlacementColorItem;
window.removePlacementColorItem = removePlacementColorItem;
window.updatePlacementColorValue = updatePlacementColorValue;
window.updatePlacementScreenLetter = updatePlacementScreenLetter;
  </script>
</body>
</html>
